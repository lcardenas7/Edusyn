generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SchoolShift {
  MORNING
  AFTERNOON
  SINGLE
  NIGHT
}

enum GradeStage {
  PREESCOLAR
  BASICA_PRIMARIA
  BASICA_SECUNDARIA
  MEDIA
}

enum DocumentType {
  TI
  CC
  CE
  PASAPORTE
  RC
  NIP
  NUIP
}

enum PerformanceLevel {
  SUPERIOR
  ALTO
  BASICO
  BAJO
}

enum AcademicTermType {
  PERIOD
  SEMESTER_EXAM
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENUMS PARA GESTIÃ“N DE AÃ‘O LECTIVO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Estado del aÃ±o acadÃ©mico
enum AcademicYearStatus {
  DRAFT      // En configuraciÃ³n - solo Admin puede editar estructura
  ACTIVE     // Activo - docentes pueden registrar notas/asistencia
  CLOSED     // Cerrado - solo lectura, histÃ³rico
}

// Tipo de calendario acadÃ©mico (Colombia)
enum CalendarType {
  A          // Calendario A (Feb-Nov)
  B          // Calendario B (Sep-Jun)
  FLEXIBLE   // Calendario flexible
}

// Estado de matrÃ­cula
enum EnrollmentStatus {
  ACTIVE       // Matriculado actualmente
  PROMOTED     // Promovido al siguiente grado
  REPEATED     // Repite el mismo grado
  WITHDRAWN    // Retirado
  TRANSFERRED  // Trasladado a otra instituciÃ³n
}

// Tipo de matrÃ­cula
enum EnrollmentType {
  NEW          // MatrÃ­cula nueva (primer ingreso)
  RENEWAL      // RenovaciÃ³n (estudiante antiguo)
  TRANSFER_IN  // Traslado desde otra instituciÃ³n
  REENTRY      // Reingreso (estuvo retirado)
}

// Tipo de evento de matrÃ­cula (auditorÃ­a)
enum EnrollmentEventType {
  CREATED              // MatrÃ­cula inicial
  GROUP_CHANGED        // Cambio de grupo/curso
  WITHDRAWN            // Retiro
  TRANSFERRED          // Traslado
  PROMOTED             // PromociÃ³n
  REPEATED             // Repitencia
  REACTIVATED          // Reingreso
  STATUS_CHANGED       // Cambio de estado genÃ©rico
  GRADE_CORRECTED      // CorrecciÃ³n de nota (con acta)
  PROMOTION_EXCEPTION  // PromociÃ³n excepcional (comitÃ©)
}

// Tipo de movimiento de matrÃ­cula
enum EnrollmentMovementType {
  ADMINISTRATIVE    // Cambio por razones administrativas
  ACADEMIC          // Cambio por razones acadÃ©micas
}

// Tipo de acta acadÃ©mica
enum AcademicActType {
  GRADE_CORRECTION       // CorrecciÃ³n de nota
  PROMOTION_EXCEPTION    // PromociÃ³n excepcional
  ATTENDANCE_CORRECTION  // CorrecciÃ³n de asistencia
  ENROLLMENT_CORRECTION  // CorrecciÃ³n de matrÃ­cula
  COMMITTEE_DECISION     // DecisiÃ³n de comitÃ© acadÃ©mico
  YEAR_CLOSURE           // Cierre de aÃ±o lectivo
  ACADEMIC_COUNCIL       // Acta de consejo acadÃ©mico
  PROMOTION              // Acta de promociÃ³n
  RECOVERY_APPROVAL      // Acta de aprobaciÃ³n de recuperaciÃ³n
  FINAL_DECISION         // Acta de decisiÃ³n final
}

// Modalidad de estudio
enum StudyModality {
  PRESENTIAL   // Presencial
  VIRTUAL      // Virtual
  HYBRID       // HÃ­brido
}

// Estado de la instituciÃ³n
enum InstitutionStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  INACTIVE
}

// ConfiguraciÃ³n de cÃ¡lculo de Ã¡reas
enum AreaCalculationType {
  INFORMATIVE      // Solo informativa, no afecta promociÃ³n
  AVERAGE          // Promedio simple de asignaturas
  WEIGHTED         // Promedio ponderado por porcentajes
  DOMINANT         // La asignatura dominante define el Ã¡rea
}

// Regla de aprobaciÃ³n de Ã¡reas
enum AreaApprovalRule {
  AREA_AVERAGE           // Por promedio del Ã¡rea
  ALL_SUBJECTS_PASS      // Todas las asignaturas aprobadas
  DOMINANT_SUBJECT_PASS  // Solo importa la asignatura dominante
}

// Regla de recuperaciÃ³n de Ã¡reas
enum AreaRecoveryRule {
  INDIVIDUAL_SUBJECT  // Se recuperan asignaturas individuales
  FULL_AREA           // Se recupera el Ã¡rea completa
  CONDITIONAL         // SegÃºn reglas especÃ­ficas
  NONE                // No permite recuperaciÃ³n
}

// MÃ³dulos disponibles en el sistema
enum SystemModule {
  ACADEMIC           // GestiÃ³n acadÃ©mica (notas, Ã¡reas, asignaturas)
  ENROLLMENTS        // MatrÃ­culas y gestiÃ³n de estudiantes
  ATTENDANCE         // Control de asistencia
  EVALUATION         // Actividades evaluativas
  RECOVERY           // Recuperaciones
  REPORTS            // Reportes y boletines
  COMMUNICATIONS     // Mensajes, anuncios, galerÃ­a
  OBSERVER           // Observador del estudiante
  PERFORMANCE        // DesempeÃ±o y estadÃ­sticas
  MEN_REPORTS        // Reportes para el MEN
  DASHBOARD          // Dashboard y analytics
  USERS              // GestiÃ³n de usuarios
  CONFIG             // ConfiguraciÃ³n institucional
  ELECTIONS          // Elecciones escolares
  PAYMENTS           // GestiÃ³n de pagos y eventos financieros
  FINANCE            // GestiÃ³n financiera (cobros, pagos, egresos, facturas)
  TIMETABLE          // GestiÃ³n de horarios escolares
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENUMS PARA PLANTILLAS ACADÃ‰MICAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Nivel acadÃ©mico para plantillas
enum AcademicLevel {
  PREESCOLAR
  PRIMARIA
  SECUNDARIA
  MEDIA
  MEDIA_TECNICA
  OTRO
}

// Tipo de asignatura
enum SubjectType {
  MANDATORY       // Obligatoria
  ELECTIVE        // Electiva
  OPTIONAL        // Opcional
  TECHNICAL       // TÃ©cnica (media tÃ©cnica)
}

// Tipo de excepciÃ³n de grupo
enum GroupExceptionType {
  EXCLUDE         // Excluir asignatura del grupo
  INCLUDE         // Incluir asignatura adicional
  MODIFY          // Modificar configuraciÃ³n (horas, peso, etc.)
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTRUCTURA ACADÃ‰MICA POR GRADO
// Define cÃ³mo se organiza acadÃ©micamente cada grado
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

enum AcademicStructureType {
  DIMENSIONS      // Preescolar: Dimensiones cualitativas (sin notas numÃ©ricas)
  SUBJECTS_ONLY   // Asignaturas simples sin Ã¡reas (primaria baja opcional)
  AREAS_SUBJECTS  // Modelo tradicional: Ãreas con asignaturas ponderadas
}

model User {
  id             String     @id @default(cuid())
  email          String     @unique
  username       String?    @unique
  passwordHash   String
  firstName      String
  lastName       String
  documentType   DocumentType?
  documentNumber String?
  phone          String?
  birthDate      DateTime?
  isActive       Boolean    @default(true)
  isSuperAdmin   Boolean    @default(false)  // SuperAdmin del sistema
  mustChangePassword Boolean @default(false) // Forzar cambio de contraseÃ±a en primer login
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  roles              UserRole[]
  institutionUsers   InstitutionUser[]  // RelaciÃ³n con instituciones
  teacherAssignments TeacherAssignment[]
  studentObservations StudentObservation[]
  messages           Message[]
  announcements      Announcement[] @relation("AnnouncementAuthor")
  galleryImages      GalleryImage[] @relation("GalleryUploader")
  events             Event[]        @relation("EventAuthor")
  periodFinalGrades  PeriodFinalGrade[] @relation("PeriodGradeEnteredBy")
  
  // Recuperaciones
  periodRecoveriesAssigned  PeriodRecovery[]    @relation("RecoveryAssignedBy")
  periodRecoveriesEvaluated PeriodRecovery[]    @relation("RecoveryEvaluatedBy")
  finalRecoveriesTeacher    FinalRecoveryPlan[] @relation("FinalRecoveryTeacher")
  finalRecoveriesSupervisor FinalRecoveryPlan[] @relation("FinalRecoverySupervisor")
  finalRecoveriesApprover   FinalRecoveryPlan[] @relation("FinalRecoveryApprover")
  academicActsCreated       AcademicAct[]       @relation("ActCreatedBy")
  academicActsApproved      AcademicAct[]       @relation("ActApprovedBy")
  performanceManualEdits    PerformanceManualEdit[] @relation("PerformanceEditedBy")
  
  // Instituciones creadas por SuperAdmin
  institutionsCreated       Institution[]       @relation("InstitutionCreatedBy")
  
  // GestiÃ³n de AÃ±o Lectivo
  yearsActivated            AcademicYear[]      @relation("YearActivatedBy")
  yearsClosed               AcademicYear[]      @relation("YearClosedBy")
  enrollmentsCreated        StudentEnrollment[] @relation("EnrollmentCreatedBy")
  enrollmentEventsPerformed EnrollmentEvent[]   @relation("EnrollmentEventPerformedBy")
  
  // Sistema de permisos granulares
  extraPermissions          UserExtraPermission[] @relation("UserExtraPermissions")
  permissionsGranted        UserExtraPermission[] @relation("GrantedPermissions")
  permissionsRevoked        UserExtraPermission[] @relation("RevokedPermissions")
  auditLogsAsTarget         PermissionAuditLog[]  @relation("AuditTarget")
  auditLogsAsPerformer      PermissionAuditLog[]  @relation("AuditPerformer")
  
  // Estudiante asociado (si el usuario es un estudiante con acceso)
  studentProfile            Student?
  
  // Elecciones
  electionProcessesCreated  ElectionProcess[] @relation("ElectionProcessCreatedBy")
  candidatesApproved        Candidate[]       @relation("CandidateApprovedBy")
  
  // Documentos validados
  documentsValidated        StudentDocument[] @relation("DocumentValidatedBy")
  
  // Pagos
  paymentEventsCreated      PaymentEvent[]         @relation("PaymentEventCreatedBy")
  paymentsReceived          PaymentTransaction[]   @relation("PaymentReceivedBy")
  
  // Logros aprobados
  achievementsApproved      StudentAchievement[]   @relation("AchievementApprovedBy")
  
  // Documentos institucionales y GestiÃ³n de tareas
  documentsUploaded         InstitutionalDocument[] @relation("DocumentUploader")
  managementLeaderRoles     ManagementLeader[]      @relation("ManagementLeaderUser")
  managementLeadersAssigned ManagementLeader[]      @relation("ManagementLeaderAssigner")
  tasksCreated              ManagementTask[]        @relation("TaskCreatedBy")
  taskAssignments           TaskAssignment[]        @relation("TaskAssignee")
  taskVerifications         TaskAssignment[]        @relation("TaskVerifier")
  
  // Snapshot de docentes en matrÃ­culas (histÃ³rico)
  enrollmentSubjectsAsTeacher EnrollmentSubject[]   @relation("EnrollmentSubjectTeacher")
  
  // MÃ³dulo Financiero
  paymentsReceivedFinancial   FinancialPayment[]    @relation("PaymentReceivedBy")
  paymentsVoided              FinancialPayment[]    @relation("PaymentVoidedBy")
  expensesRegistered          FinancialExpense[]    @relation("ExpenseRegisteredBy")
  expensesApproved            FinancialExpense[]    @relation("ExpenseApprovedBy")
  expensesVoided              FinancialExpense[]    @relation("ExpenseVoidedBy")
  invoicesCreated             FinancialInvoice[]    @relation("InvoiceCreatedBy")
  invoicesCancelled           FinancialInvoice[]    @relation("InvoiceCancelledBy")
  cashRegisterCloses          CashRegisterClose[]
  
  // Timetabling (Horarios)
  teacherAvailabilities       TeacherAvailability[] @relation("TeacherScheduleAvailability")
}

model Role {
  id        String     @id @default(cuid())
  name      String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  users UserRole[]
}

model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model Institution {
  id          String            @id @default(cuid())
  name        String
  daneCode    String?           @unique
  nit         String?
  slug        String            @unique  // URL amigable para login (ej: "colegio-san-jose")
  logo        String?                    // URL del logo
  address     String?                    // DirecciÃ³n de la instituciÃ³n
  phone       String?                    // TelÃ©fono de contacto
  email       String?                    // Email institucional
  website     String?                    // Sitio web
  status      InstitutionStatus @default(TRIAL)
  trialEndsAt DateTime?                  // Fecha fin del perÃ­odo de prueba
  createdById String?                    // SuperAdmin que creÃ³ la instituciÃ³n
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONFIGURACIÃ“N INSTITUCIONAL (persistida en BD)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // ConfiguraciÃ³n Global de Ãreas
  areaCalculationType     AreaCalculationType  @default(WEIGHTED)
  areaApprovalRule        AreaApprovalRule     @default(AREA_AVERAGE)
  areaRecoveryRule        AreaRecoveryRule     @default(INDIVIDUAL_SUBJECT)
  areaFailIfAnyFails      Boolean              @default(false)  // Pierde Ã¡rea si cualquier asignatura pierde
  
  // ConfiguraciÃ³n del Sistema de CalificaciÃ³n (JSON para flexibilidad)
  gradingConfig           Json?                // Procesos evaluativos, subprocesos, ponderaciones
  
  // Niveles AcadÃ©micos y sus escalas (JSON)
  academicLevelsConfig    Json?                // Niveles, escalas cualitativas/numÃ©ricas
  
  // PerÃ­odos AcadÃ©micos (JSON)
  periodsConfig           Json?                // PerÃ­odos con fechas y ponderaciones

  // Relaciones
  createdBy   User?             @relation("InstitutionCreatedBy", fields: [createdById], references: [id])
  modules     InstitutionModule[]  // MÃ³dulos habilitados
  users       InstitutionUser[]    // Usuarios de esta instituciÃ³n
  
  campuses          Campus[]
  areas             Area[]
  academicTemplates AcademicTemplate[]
  academicYears     AcademicYear[]
  performanceScale PerformanceScale[]
  evaluationComponents EvaluationComponent[]
  students      Student[]
  guardians     Guardian[]
  messages      Message[]
  announcements Announcement[]
  galleryImages GalleryImage[]
  events        Event[]
  recoveryConfigs RecoveryConfig[]
  academicActs    AcademicAct[]
  performanceLevelComplements PerformanceLevelComplement[]
  performanceConfig           PerformanceConfig?
  achievementConfig           AchievementConfig?
  permissionAuditLogs         PermissionAuditLog[]
  electionProcesses           ElectionProcess[]
  
  // Pagos
  paymentConcepts             PaymentConcept[]
  paymentEvents               PaymentEvent[]
  
  // Documentos y GestiÃ³n
  institutionalDocuments      InstitutionalDocument[]
  managementLeaders           ManagementLeader[]
  managementTasks             ManagementTask[]
  storageUsage                InstitutionStorageUsage?
  
  // MÃ³dulo Financiero
  financialThirdParties       FinancialThirdParty[]
  financialCategories         FinancialCategory[]
  chargeConcepts              ChargeConcept[]
  financialObligations        FinancialObligation[]
  financialPayments           FinancialPayment[]
  financialExpenses           FinancialExpense[]
  financialInvoices           FinancialInvoice[]
  financialSettings           FinancialSettings?
  cashRegisterCloses          CashRegisterClose[]
  
  // Timetabling (Horarios)
  timeBlocks                  TimeBlock[]
  rooms                       Room[]
  scheduleGradeConfigs        ScheduleGradeConfig[]
  teacherAvailabilities       TeacherAvailability[]
  scheduleEntries             ScheduleEntry[]
}

// MÃ³dulos habilitados por instituciÃ³n
model InstitutionModule {
  id            String       @id @default(cuid())
  institutionId String
  module        SystemModule
  isActive      Boolean      @default(true)
  activatedAt   DateTime     @default(now())
  expiresAt     DateTime?    // Fecha de expiraciÃ³n del mÃ³dulo (si aplica)
  features      String[]     // Funcionalidades especÃ­ficas habilitadas dentro del mÃ³dulo
  
  institution   Institution  @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  
  @@unique([institutionId, module])
}

// RelaciÃ³n Usuario-InstituciÃ³n (un usuario puede pertenecer a varias instituciones)
model InstitutionUser {
  id            String   @id @default(cuid())
  userId        String
  institutionId String
  isAdmin       Boolean  @default(false)  // Es admin/rector de esta instituciÃ³n
  isActive      Boolean  @default(true)
  joinedAt      DateTime @default(now())
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  
  @@unique([userId, institutionId])
}

model Campus {
  id            String   @id @default(cuid())
  institutionId String
  name          String
  address       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  shifts      Shift[]
  groups      Group[]
  rooms       Room[]

  @@unique([institutionId, name])
}

model Shift {
  id        String      @id @default(cuid())
  campusId  String
  type      SchoolShift
  name      String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  campus Campus @relation(fields: [campusId], references: [id], onDelete: Cascade)
  groups Group[]
  timeBlocks TimeBlock[]

  @@unique([campusId, type])
}

model Grade {
  id        String     @id @default(cuid())
  stage     GradeStage
  number    Int?
  name      String
  
  // ğŸ†• Estructura acadÃ©mica del grado (define comportamiento del sistema)
  academicStructure AcademicStructureType @default(AREAS_SUBJECTS)
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  groups        Group[]
  elections      Election[]       // Elecciones de representante de grado
  gradeTemplates GradeTemplate[]  // Plantillas acadÃ©micas por aÃ±o (una por aÃ±o acadÃ©mico)
  scheduleGradeConfigs ScheduleGradeConfig[]

  @@unique([stage, name])
}

model Group {
  id          String   @id @default(cuid())
  campusId    String
  shiftId     String
  gradeId     String
  code        String?
  name        String
  maxCapacity Int?     // Cupo mÃ¡ximo del grupo (null = sin lÃ­mite)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campus Campus @relation(fields: [campusId], references: [id], onDelete: Restrict)
  shift  Shift  @relation(fields: [shiftId], references: [id], onDelete: Restrict)
  grade  Grade  @relation(fields: [gradeId], references: [id], onDelete: Restrict)

  teacherAssignments  TeacherAssignment[]
  studentEnrollments  StudentEnrollment[]
  elections           Election[]              // Elecciones de representante de curso
  subjectExceptions   GroupSubjectException[] // Excepciones de asignaturas para este grupo
  scheduleEntries     ScheduleEntry[]

  @@unique([campusId, shiftId, gradeId, name])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATÃLOGO ACADÃ‰MICO INSTITUCIONAL
// Las Ã¡reas y asignaturas se crean UNA SOLA VEZ como catÃ¡logo
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// CatÃ¡logo de Ãreas (institucional, no depende de grados ni grupos)
model Area {
  id            String   @id @default(cuid())
  institutionId String
  name          String
  code          String?  // CÃ³digo corto (MAT, LEN, NAT, etc.)
  description   String?
  order         Int      @default(0)
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution       Institution          @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  subjects          Subject[]
  templateAreas     TemplateArea[]
  finalRecoveryPlans FinalRecoveryPlan[]
  enrollmentAreas   EnrollmentArea[]     // Snapshots en matrÃ­culas

  @@unique([institutionId, name])
  @@index([institutionId])
}

// CatÃ¡logo de Asignaturas (pertenecen a un Ã¡rea del catÃ¡logo)
model Subject {
  id            String      @id @default(cuid())
  areaId        String
  name          String
  code          String?     // CÃ³digo corto (MAT01, GEO, BIO, etc.)
  description   String?
  subjectType   SubjectType @default(MANDATORY)
  order         Int         @default(0)
  isActive      Boolean     @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  area                   Area                    @relation(fields: [areaId], references: [id], onDelete: Cascade)
  templateSubjects       TemplateSubject[]
  teacherAssignments     TeacherAssignment[]
  periodFinalGrades      PeriodFinalGrade[]
  periodRecoveries       PeriodRecovery[]
  performanceManualEdits PerformanceManualEdit[]
  groupExceptions        GroupSubjectException[]
  enrollmentSubjects     EnrollmentSubject[]     // Snapshots en matrÃ­culas
  roomRestrictions       RoomRestriction[]

  @@unique([areaId, name])
  @@index([areaId])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLANTILLAS ACADÃ‰MICAS
// La "receta" que define quÃ© Ã¡reas/asignaturas tiene un nivel o grado
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Plantilla AcadÃ©mica (ej: "Primaria EstÃ¡ndar", "Media TÃ©cnica Sistemas")
model AcademicTemplate {
  id              String        @id @default(cuid())
  institutionId   String
  academicYearId  String        // ğŸ”¥ CRÃTICO: Plantilla pertenece a un aÃ±o especÃ­fico
  name            String        // "Plantilla Primaria", "Media TÃ©cnica"
  description     String?
  level           AcademicLevel // Nivel acadÃ©mico principal
  isDefault       Boolean       @default(false) // Plantilla por defecto para el nivel en este aÃ±o
  isActive        Boolean       @default(true)
  
  // ConfiguraciÃ³n de logros para esta plantilla
  achievementsPerPeriod     Int     @default(1)   // Logros acadÃ©micos por perÃ­odo
  useAttitudinalAchievement Boolean @default(false) // Usa logro actitudinal
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution    Institution      @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  academicYear   AcademicYear     @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  templateAreas  TemplateArea[]
  templateDimensions TemplateDimension[]  // ğŸ†• Para estructura DIMENSIONS (preescolar)
  gradeTemplates GradeTemplate[]

  @@unique([institutionId, academicYearId, name]) // Nombre Ãºnico por instituciÃ³n Y aÃ±o
  @@index([institutionId, academicYearId, level])
  @@index([academicYearId])
}

// Ãrea dentro de una plantilla (con su configuraciÃ³n especÃ­fica)
model TemplateArea {
  id              String              @id @default(cuid())
  templateId      String
  areaId          String
  
  // ConfiguraciÃ³n del Ã¡rea en esta plantilla
  weightPercentage Float              @default(0)  // % del Ã¡rea en el promedio general (0-100)
  calculationType  AreaCalculationType @default(AVERAGE)
  approvalRule     AreaApprovalRule   @default(AREA_AVERAGE)
  recoveryRule     AreaRecoveryRule   @default(INDIVIDUAL_SUBJECT)
  isMandatory      Boolean            @default(true)
  order            Int                @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  template         AcademicTemplate   @relation(fields: [templateId], references: [id], onDelete: Cascade)
  area             Area               @relation(fields: [areaId], references: [id], onDelete: Cascade)
  templateSubjects TemplateSubject[]

  @@unique([templateId, areaId])
  @@index([templateId])
  @@index([areaId])
}

// Asignatura dentro de un Ã¡rea de plantilla (con su configuraciÃ³n especÃ­fica)
model TemplateSubject {
  id              String   @id @default(cuid())
  templateAreaId  String
  subjectId       String
  
  // ConfiguraciÃ³n de la asignatura en esta plantilla
  weeklyHours     Int      @default(0)      // Horas semanales
  weightPercentage Float   @default(0)      // % dentro del Ã¡rea (0-100)
  isDominant      Boolean  @default(false)  // Es la asignatura dominante del Ã¡rea
  order           Int      @default(0)
  
  // ConfiguraciÃ³n de logros especÃ­fica (sobrescribe la de la plantilla si se define)
  achievementsPerPeriod     Int?     // NULL = usa el de la plantilla
  useAttitudinalAchievement Boolean? // NULL = usa el de la plantilla
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  templateArea    TemplateArea @relation(fields: [templateAreaId], references: [id], onDelete: Cascade)
  subject         Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([templateAreaId, subjectId])
  @@index([templateAreaId])
  @@index([subjectId])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIMENSIONES DEL DESARROLLO (PREESCOLAR)
// CatÃ¡logo global de dimensiones pedagÃ³gicas
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// CatÃ¡logo de Dimensiones (global, no institucional)
model Dimension {
  id          String   @id @default(cuid())
  name        String   // "Cognitiva", "Comunicativa", "Corporal", etc.
  code        String?  // CÃ³digo corto opcional
  description String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  templateDimensions   TemplateDimension[]
  enrollmentDimensions EnrollmentDimension[]
}

// DimensiÃ³n dentro de una plantilla (para estructura DIMENSIONS)
model TemplateDimension {
  id          String   @id @default(cuid())
  templateId  String
  dimensionId String
  order       Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  template    AcademicTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  dimension   Dimension        @relation(fields: [dimensionId], references: [id], onDelete: Cascade)

  @@unique([templateId, dimensionId])
  @@index([templateId])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ASIGNACIÃ“N DE PLANTILLAS A GRADOS
// El grado hereda la configuraciÃ³n de una plantilla
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// AsignaciÃ³n de plantilla a un grado POR AÃ‘O ACADÃ‰MICO
model GradeTemplate {
  id              String   @id @default(cuid())
  gradeId         String
  templateId      String
  academicYearId  String   // ğŸ”¥ CRÃTICO: AsignaciÃ³n es por aÃ±o
  
  // Sobrescrituras especÃ­ficas del grado (JSON para flexibilidad)
  // Ej: {"excludeSubjects": ["id1"], "modifyHours": {"id2": 4}}
  overrides   Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  grade        Grade            @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  template     AcademicTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  academicYear AcademicYear     @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@unique([gradeId, academicYearId]) // Un grado solo puede tener una plantilla POR AÃ‘O
  @@index([templateId])
  @@index([academicYearId])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXCEPCIONES POR GRUPO
// Ajustes especÃ­ficos que un grupo tiene sobre la plantilla heredada
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ExcepciÃ³n de asignatura por grupo POR AÃ‘O ACADÃ‰MICO
model GroupSubjectException {
  id              String             @id @default(cuid())
  groupId         String
  subjectId       String
  academicYearId  String             // ğŸ”¥ CRÃTICO: ExcepciÃ³n es por aÃ±o
  type            GroupExceptionType
  
  // ConfiguraciÃ³n modificada (solo aplica si type = MODIFY)
  weeklyHours      Int?
  weightPercentage Float?
  
  reason      String?  // RazÃ³n de la excepciÃ³n
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  group        Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  subject      Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@unique([groupId, subjectId, academicYearId]) // ExcepciÃ³n Ãºnica por grupo+asignatura+aÃ±o
  @@index([groupId])
  @@index([subjectId])
  @@index([academicYearId])
}

model AcademicYear {
  id            String             @id @default(cuid())
  institutionId String
  year          Int
  name          String?            // "AÃ±o Lectivo 2025"
  startDate     DateTime?
  endDate       DateTime?
  status        AcademicYearStatus @default(ACTIVE)
  // isCurrent es derivado: isCurrent = (status === ACTIVE)
  // Solo puede haber 1 ACTIVE por instituciÃ³n (validar en cÃ³digo)
  
  // AuditorÃ­a de cambios de estado
  activatedAt   DateTime?
  activatedById String?
  closedAt      DateTime?
  closedById    String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution       Institution        @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  activatedBy       User?              @relation("YearActivatedBy", fields: [activatedById], references: [id])
  closedBy          User?              @relation("YearClosedBy", fields: [closedById], references: [id])
  
  // Calendario acadÃ©mico
  calendar          AcademicCalendar?
  
  // Relaciones acadÃ©micas
  periods           Period[]
  terms             AcademicTerm[]
  teacherAssignments TeacherAssignment[]
  studentEnrollments StudentEnrollment[]
  recoveryConfigs    RecoveryConfig[]
  finalRecoveryPlans FinalRecoveryPlan[] @relation("FinalRecoveryYear")
  academicActs       AcademicAct[]
  electionProcesses  ElectionProcess[]
  paymentEvents      PaymentEvent[]
  
  // ğŸ”¥ Estructura acadÃ©mica por aÃ±o (histÃ³rico inmutable)
  academicTemplates      AcademicTemplate[]
  gradeTemplates         GradeTemplate[]
  groupSubjectExceptions GroupSubjectException[]

  // Timetabling (Horarios)
  scheduleGradeConfigs   ScheduleGradeConfig[]
  teacherAvailabilities  TeacherAvailability[]
  scheduleEntries        ScheduleEntry[]

  @@unique([institutionId, year])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDARIO ACADÃ‰MICO (Obligatorio en Colombia)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model AcademicCalendar {
  id              String        @id @default(cuid())
  academicYearId  String        @unique
  type            CalendarType  @default(A) // A, B, Flexible
  
  // InformaciÃ³n del calendario
  totalWeeks      Int           @default(40) // Semanas lectivas
  totalHours      Int           @default(800) // Horas totales
  classStartDate  DateTime?     // Inicio de clases
  classEndDate    DateTime?     // Fin de clases
  
  // Semanas de desarrollo institucional
  developmentWeeks Int          @default(5)
  
  // Vacaciones y recesos (JSON array)
  vacations       Json?         // [{ name, startDate, endDate }]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  academicYear    AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
}

model Period {
  id             String   @id @default(cuid())
  academicYearId String
  name           String
  order          Int
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@unique([academicYearId, order])
}

model AcademicTerm {
  id             String           @id @default(cuid())
  academicYearId String
  type           AcademicTermType
  name           String
  order          Int
  weightPercentage Int
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  evaluationPlans EvaluationPlan[]
  evaluativeActivities EvaluativeActivity[]
  preventiveCutConfig PreventiveCutConfig?
  preventiveAlerts PreventiveAlert[]
  periodFinalGrades PeriodFinalGrade[]
  partialGrades PartialGrade[]
  periodRecoveries  PeriodRecovery[] @relation("PeriodRecoveryTerm")
  subjectPerformances SubjectPerformance[]
  performanceManualEdits PerformanceManualEdit[]
  gradingPeriodConfig GradingPeriodConfig?
  recoveryPeriodConfig RecoveryPeriodConfig? @relation("RecoveryPeriodConfig")
  achievements Achievement[]
  attitudinalAchievements AttitudinalAchievement[]

  @@unique([academicYearId, order])
}

// ConfiguraciÃ³n de ventana de calificaciones por perÃ­odo
model GradingPeriodConfig {
  id              String    @id @default(cuid())
  academicTermId  String    @unique
  isOpen          Boolean   @default(false)
  openDate        DateTime?
  closeDate       DateTime?
  allowLateEntry  Boolean   @default(false)
  lateEntryDays   Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  academicTerm AcademicTerm @relation(fields: [academicTermId], references: [id], onDelete: Cascade)
}

// ConfiguraciÃ³n de ventana de recuperaciones por perÃ­odo
model RecoveryPeriodConfig {
  id              String    @id @default(cuid())
  academicTermId  String    @unique
  isOpen          Boolean   @default(false)
  openDate        DateTime?
  closeDate       DateTime?
  allowLateEntry  Boolean   @default(false)
  lateEntryDays   Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  academicTerm AcademicTerm @relation("RecoveryPeriodConfig", fields: [academicTermId], references: [id], onDelete: Cascade)
}

model TeacherAssignment {
  id            String   @id @default(cuid())
  academicYearId String
  groupId       String
  subjectId     String
  teacherId     String
  weeklyHours   Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  group        Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  subject      Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher      User         @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  evaluativeActivities EvaluativeActivity[]
  evaluationPlans EvaluationPlan[]
  preventiveAlerts PreventiveAlert[]
  attendanceRecords AttendanceRecord[]
  subjectPerformances SubjectPerformance[]
  partialGrades PartialGrade[]
  achievements Achievement[]
  attitudinalAchievements AttitudinalAchievement[]
  scheduleEntries         ScheduleEntry[]

  @@unique([academicYearId, groupId, subjectId, teacherId])
}

model PerformanceScale {
  id            String           @id @default(cuid())
  institutionId String
  level         PerformanceLevel
  minScore      Decimal
  maxScore      Decimal
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@unique([institutionId, level])
}

model EvaluativeActivity {
  id                 String   @id @default(cuid())
  teacherAssignmentId String
  academicTermId     String
  evaluationPlanId   String
  componentId        String
  name               String
  dueDate            DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  teacherAssignment TeacherAssignment @relation(fields: [teacherAssignmentId], references: [id], onDelete: Cascade)
  academicTerm      AcademicTerm      @relation(fields: [academicTermId], references: [id], onDelete: Cascade)
  evaluationPlan     EvaluationPlan   @relation(fields: [evaluationPlanId], references: [id], onDelete: Cascade)
  component          EvaluationComponent @relation(fields: [componentId], references: [id], onDelete: Restrict)
  studentGrades      StudentGrade[]

  @@index([teacherAssignmentId])
  @@index([academicTermId])
  @@index([evaluationPlanId])
  @@index([componentId])
}

model EvaluationPlan {
  id                 String   @id @default(cuid())
  teacherAssignmentId String
  academicTermId     String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  teacherAssignment TeacherAssignment @relation(fields: [teacherAssignmentId], references: [id], onDelete: Cascade)
  academicTerm      AcademicTerm      @relation(fields: [academicTermId], references: [id], onDelete: Cascade)

  components EvaluationPlanComponentWeight[]
  activities EvaluativeActivity[]

  @@unique([teacherAssignmentId, academicTermId])
}

model EvaluationComponent {
  id              String   @id @default(cuid())
  institutionId   String
  parentId        String?
  code            String
  name            String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  parent      EvaluationComponent? @relation("EvalComponentHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children    EvaluationComponent[] @relation("EvalComponentHierarchy")

  planWeights EvaluationPlanComponentWeight[]
  activities  EvaluativeActivity[]

  @@unique([institutionId, code])
}

model EvaluationPlanComponentWeight {
  id               String   @id @default(cuid())
  evaluationPlanId String
  componentId      String
  percentage       Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  evaluationPlan EvaluationPlan @relation(fields: [evaluationPlanId], references: [id], onDelete: Cascade)
  component      EvaluationComponent @relation(fields: [componentId], references: [id], onDelete: Restrict)

  @@unique([evaluationPlanId, componentId])
}

model Student {
  id            String   @id @default(cuid())
  institutionId String
  userId        String?  @unique  // Usuario opcional para acceso al sistema
  
  // InformaciÃ³n bÃ¡sica
  documentType  String
  documentNumber String
  firstName     String
  secondName    String?
  lastName      String
  secondLastName String?
  birthDate     DateTime?
  birthPlace    String?
  gender        String?
  email         String?
  phone         String?
  address       String?
  neighborhood  String?
  city          String?
  
  // InformaciÃ³n mÃ©dica
  bloodType     String?
  eps           String?
  allergies     String?
  medicalConditions String?
  medications   String?
  emergencyContact String?
  emergencyPhone String?
  
  // InformaciÃ³n socioeconÃ³mica (para reportes MEN)
  stratum       Int?
  sisbenLevel   String?
  ethnicity     String?
  displacement  Boolean  @default(false)
  disability    String?
  disabilityType String?
  
  // InformaciÃ³n adicional
  previousSchool String?
  photo         String?
  observations  String?
  
  // Estado del registro
  isActive      Boolean  @default(true)  // false = borrado lÃ³gico
  deletedAt     DateTime?                // Fecha de borrado lÃ³gico
  deletedReason String?                  // RazÃ³n del borrado
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  user          User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  enrollments   StudentEnrollment[]
  guardians     StudentGuardian[]
  
  // Elecciones
  candidatures  Candidate[]   // Candidaturas del estudiante
  votes         Vote[]        @relation("VoterVotes") // Votos emitidos
  
  // Documentos
  documents     StudentDocument[]
  
  // Pagos
  payments      StudentPayment[]

  @@unique([institutionId, documentNumber])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOCUMENTOS DE MATRÃCULA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model StudentDocument {
  id            String              @id @default(cuid())
  studentId     String
  type          EnrollmentDocType
  name          String              // Nombre descriptivo del documento
  fileUrl       String?        // URL del archivo subido
  fileName      String?        // Nombre original del archivo
  fileSize      Int?           // TamaÃ±o en bytes
  mimeType      String?        // Tipo MIME del archivo
  status        DocumentStatus @default(PENDING)
  
  // ValidaciÃ³n
  validatedById String?
  validatedAt   DateTime?
  rejectionReason String?
  
  // Metadatos
  observations  String?
  expirationDate DateTime?     // Fecha de vencimiento (ej: EPS)
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  student       Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  validatedBy   User?          @relation("DocumentValidatedBy", fields: [validatedById], references: [id])

  @@index([studentId])
  @@index([type])
  @@index([status])
}

enum EnrollmentDocType {
  REGISTRO_CIVIL
  TARJETA_IDENTIDAD
  CEDULA
  FOTO
  BOLETIN_ANTERIOR
  CERTIFICADO_ESTUDIO
  CERTIFICADO_CONDUCTA
  EPS
  SISBEN
  CARNET_VACUNACION
  PAZ_Y_SALVO
  OTRO
}

enum DocumentStatus {
  PENDING     // Pendiente de entrega
  DELIVERED   // Entregado, pendiente de validaciÃ³n
  VALIDATED   // Validado y aprobado
  REJECTED    // Rechazado
  EXPIRED     // Vencido
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACUDIENTES / PADRES DE FAMILIA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Guardian {
  id              String   @id @default(cuid())
  institutionId   String
  
  // InformaciÃ³n bÃ¡sica
  documentType    String
  documentNumber  String
  firstName       String
  secondName      String?
  lastName        String
  secondLastName  String?
  
  // Contacto
  phone           String
  alternatePhone  String?
  email           String?
  address         String?
  neighborhood    String?
  city            String?
  
  // InformaciÃ³n laboral
  occupation      String?
  workplace       String?
  workPhone       String?
  workAddress     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  institution     Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  students        StudentGuardian[]

  @@unique([institutionId, documentNumber])
}

model StudentGuardian {
  id          String   @id @default(cuid())
  studentId   String
  guardianId  String
  
  // Tipo de relaciÃ³n
  relationship GuardianRelationship
  isPrimary   Boolean  @default(false)
  canPickUp   Boolean  @default(true)
  isEmergencyContact Boolean @default(false)
  
  // Permisos
  receivesNotifications Boolean @default(true)
  receivesGrades Boolean @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  guardian    Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)

  @@unique([studentId, guardianId])
}

enum GuardianRelationship {
  FATHER
  MOTHER
  STEPFATHER
  STEPMOTHER
  GRANDFATHER
  GRANDMOTHER
  UNCLE
  AUNT
  SIBLING
  LEGAL_GUARDIAN
  OTHER
}

model StudentEnrollment {
  id              String           @id @default(cuid())
  studentId       String
  academicYearId  String
  groupId         String
  
  // Tipo y estado de matrÃ­cula
  enrollmentType  EnrollmentType   @default(NEW)
  status          EnrollmentStatus @default(ACTIVE)
  
  // Jornada y modalidad
  shift           SchoolShift?     // Jornada: MaÃ±ana, Tarde, Ãšnica, Noche
  modality        StudyModality    @default(PRESENTIAL)
  
  // Fechas
  enrollmentDate  DateTime         @default(now())
  withdrawalDate  DateTime?        // Fecha de retiro si aplica
  withdrawalReason String?         // Motivo del retiro
  
  // Trazabilidad de promociÃ³n
  promotedFromId  String?  @unique // MatrÃ­cula del aÃ±o anterior (1:1)
  
  // Observaciones y auditorÃ­a
  observations    String?          // Observaciones de matrÃ­cula
  enrolledById    String?          // QuiÃ©n realizÃ³ la matrÃ­cula
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  student         Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  academicYear    AcademicYear     @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  group           Group            @relation(fields: [groupId], references: [id], onDelete: Restrict)
  enrolledBy      User?            @relation("EnrollmentCreatedBy", fields: [enrolledById], references: [id])
  
  // Trazabilidad de promociÃ³n (self-relation 1:1)
  promotedFrom    StudentEnrollment? @relation("EnrollmentPromotion", fields: [promotedFromId], references: [id])
  promotedTo      StudentEnrollment? @relation("EnrollmentPromotion")
  
  // Historial de eventos (AUDITORÃA)
  events          EnrollmentEvent[]
  
  // Relaciones acadÃ©micas
  grades              StudentGrade[]
  periodFinalGrades   PeriodFinalGrade[]
  partialGrades       PartialGrade[]
  preventiveAlerts    PreventiveAlert[]
  attendanceRecords   AttendanceRecord[]
  studentObservations StudentObservation[]
  periodRecoveries    PeriodRecovery[]
  finalRecoveryPlans  FinalRecoveryPlan[]
  academicActs        AcademicAct[]
  performanceManualEdits PerformanceManualEdit[]
  studentAchievements StudentAchievement[]
  
  // ğŸ”¥ SNAPSHOT de estructura acadÃ©mica al momento de matrÃ­cula
  enrollmentAreas      EnrollmentArea[]
  enrollmentSubjects   EnrollmentSubject[]
  enrollmentDimensions EnrollmentDimension[]  // ğŸ†• Para estructura DIMENSIONS (preescolar)

  @@unique([studentId, academicYearId])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SNAPSHOT DE ESTRUCTURA ACADÃ‰MICA POR MATRÃCULA
// Copia inmutable de la configuraciÃ³n acadÃ©mica al momento de matricular
// Protege contra cambios posteriores en plantillas que daÃ±arÃ­an histÃ³ricos
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Snapshot de Ã¡rea acadÃ©mica para una matrÃ­cula especÃ­fica
// ğŸ”¥ 100% AUTOSUFICIENTE: No depende del catÃ¡logo para existir
model EnrollmentArea {
  id                String   @id @default(cuid())
  enrollmentId      String
  areaId            String?  // Referencia OPCIONAL al catÃ¡logo (puede ser eliminada en el futuro)
  
  // Datos copiados de TemplateArea al momento de matrÃ­cula (INMUTABLES)
  areaName          String   // Nombre del Ã¡rea (snapshot)
  areaCode          String?  // CÃ³digo del Ã¡rea (snapshot)
  weightPercentage  Float    // % del Ã¡rea en promedio general
  calculationType   AreaCalculationType  // AVERAGE, WEIGHTED, DOMINANT, INFORMATIVE
  approvalRule      AreaApprovalRule     // Regla de aprobaciÃ³n
  recoveryRule      AreaRecoveryRule     // Regla de recuperaciÃ³n
  isMandatory       Boolean  @default(true)
  order             Int      @default(0)
  
  createdAt         DateTime @default(now())

  enrollment        StudentEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  area              Area?             @relation(fields: [areaId], references: [id], onDelete: SetNull)
  enrollmentSubjects EnrollmentSubject[]

  @@unique([enrollmentId, areaId])
  @@index([enrollmentId])
  @@index([areaId])
}

// Snapshot de asignatura acadÃ©mica para una matrÃ­cula especÃ­fica
// ğŸ”¥ 100% AUTOSUFICIENTE: No depende del catÃ¡logo para existir
model EnrollmentSubject {
  id                String   @id @default(cuid())
  enrollmentId      String
  enrollmentAreaId  String
  subjectId         String?  // Referencia OPCIONAL al catÃ¡logo (puede ser eliminada en el futuro)
  
  // Datos copiados de TemplateSubject al momento de matrÃ­cula (INMUTABLES)
  subjectName       String   // Nombre de la asignatura (snapshot)
  subjectCode       String?  // CÃ³digo de la asignatura (snapshot)
  weeklyHours       Int      @default(0)
  weightPercentage  Float    // % dentro del Ã¡rea
  isDominant        Boolean  @default(false)
  order             Int      @default(0)
  
  // ConfiguraciÃ³n de logros (snapshot)
  achievementsPerPeriod     Int     @default(1)
  useAttitudinalAchievement Boolean @default(false)
  
  // ğŸ”¥ Docente asignado al momento de matrÃ­cula (histÃ³rico)
  teacherId         String?  // Referencia OPCIONAL al docente
  teacherName       String?  // Nombre completo del docente (snapshot)
  
  createdAt         DateTime @default(now())

  enrollment        StudentEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  enrollmentArea    EnrollmentArea    @relation(fields: [enrollmentAreaId], references: [id], onDelete: Cascade)
  subject           Subject?          @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  teacher           User?             @relation("EnrollmentSubjectTeacher", fields: [teacherId], references: [id], onDelete: SetNull)

  @@unique([enrollmentId, subjectId])
  @@index([enrollmentId])
  @@index([enrollmentAreaId])
  @@index([subjectId])
  @@index([teacherId])
}

// Snapshot de dimensiÃ³n para una matrÃ­cula especÃ­fica (PREESCOLAR)
model EnrollmentDimension {
  id            String   @id @default(cuid())
  enrollmentId  String
  dimensionId   String?  // Referencia histÃ³rica (opcional si se elimina)
  
  // Datos copiados de Dimension al momento de matrÃ­cula (INMUTABLES)
  dimensionName String   // Nombre de la dimensiÃ³n (snapshot visible)
  dimensionCode String?  // CÃ³digo de la dimensiÃ³n (snapshot)
  order         Int      @default(0)
  
  createdAt     DateTime @default(now())

  enrollment    StudentEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  dimension     Dimension?        @relation(fields: [dimensionId], references: [id], onDelete: SetNull)

  @@unique([enrollmentId, dimensionId])
  @@index([enrollmentId])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORIAL DE MATRÃCULA (AUDITORÃA LEGAL)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model EnrollmentEvent {
  id              String                  @id @default(cuid())
  enrollmentId    String
  type            EnrollmentEventType
  movementType    EnrollmentMovementType?
  
  // AuditorÃ­a de cambios
  previousValue   Json?                   // Estado anterior (para auditorÃ­a)
  newValue        Json?                   // Estado nuevo
  reason          String?                 // Motivo del cambio
  observations    String?                 // Observaciones adicionales
  
  // Referencia a acta (si aplica)
  academicActId   String?                 // Acta que respalda el cambio
  
  // QuiÃ©n y cuÃ¡ndo
  performedById   String
  performedAt     DateTime                @default(now())
  
  enrollment      StudentEnrollment       @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  performedBy     User                    @relation("EnrollmentEventPerformedBy", fields: [performedById], references: [id])
  academicAct     AcademicAct?            @relation(fields: [academicActId], references: [id])
  
  @@index([enrollmentId])
  @@index([performedAt])
  @@index([type])
}

model StudentGrade {
  id                  String   @id @default(cuid())
  studentEnrollmentId String
  evaluativeActivityId String
  score               Decimal  @db.Decimal(3, 1)
  observations        String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  studentEnrollment StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  evaluativeActivity EvaluativeActivity @relation(fields: [evaluativeActivityId], references: [id], onDelete: Cascade)

  @@unique([studentEnrollmentId, evaluativeActivityId])
}

model PeriodFinalGrade {
  id                  String   @id @default(cuid())
  studentEnrollmentId String
  academicTermId      String
  subjectId           String
  finalScore          Decimal  @db.Decimal(3, 1)
  observations        String?
  enteredById         String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  studentEnrollment StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  academicTerm      AcademicTerm      @relation(fields: [academicTermId], references: [id], onDelete: Cascade)
  subject           Subject           @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  enteredBy         User              @relation("PeriodGradeEnteredBy", fields: [enteredById], references: [id])

  @@unique([studentEnrollmentId, academicTermId, subjectId])
}

model PartialGrade {
  id                  String   @id @default(cuid())
  studentEnrollmentId String
  teacherAssignmentId String
  academicTermId      String
  componentType       String   // COGNITIVO, PROCEDIMENTAL, ACTITUDINAL
  activityIndex       Int      // Ãndice de la actividad (1, 2, 3, etc.)
  activityName        String   // Nombre de la actividad
  activityType        String?  // Tipo de actividad (Examen, Taller, etc.)
  score               Decimal  @db.Decimal(3, 1)
  observations        String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  studentEnrollment StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  teacherAssignment TeacherAssignment @relation(fields: [teacherAssignmentId], references: [id], onDelete: Cascade)
  academicTerm      AcademicTerm      @relation(fields: [academicTermId], references: [id], onDelete: Cascade)

  @@unique([studentEnrollmentId, teacherAssignmentId, academicTermId, componentType, activityIndex])
  @@index([teacherAssignmentId, academicTermId])
}

 enum PreventiveAlertStatus {
   OPEN
   IN_RECOVERY
   RESOLVED
 }

 model PreventiveCutConfig {
   id           String   @id @default(cuid())
   academicTermId String
   cutoffDate   DateTime
   riskThresholdScore Decimal @db.Decimal(3, 1)
   createdAt    DateTime @default(now())
   updatedAt    DateTime @updatedAt

   academicTerm AcademicTerm @relation(fields: [academicTermId], references: [id], onDelete: Cascade)

   @@unique([academicTermId])
 }

 model PreventiveAlert {
   id                  String   @id @default(cuid())
   teacherAssignmentId String
   studentEnrollmentId String
   academicTermId      String
   cutoffDate          DateTime
   computedGrade       Decimal? @db.Decimal(3, 1)
   performanceLevel    PerformanceLevel?
   status              PreventiveAlertStatus @default(OPEN)
   recoveryPlan        String?
   meetingAt           DateTime?
   notes               String?
   createdAt           DateTime @default(now())
   updatedAt           DateTime @updatedAt

   teacherAssignment  TeacherAssignment  @relation(fields: [teacherAssignmentId], references: [id], onDelete: Cascade)
   studentEnrollment  StudentEnrollment  @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
   academicTerm       AcademicTerm       @relation(fields: [academicTermId], references: [id], onDelete: Cascade)

   @@unique([teacherAssignmentId, studentEnrollmentId, academicTermId])
   @@index([teacherAssignmentId])
   @@index([studentEnrollmentId])
   @@index([academicTermId])
 }

// ==================== ATTENDANCE ====================

enum AttendanceStatus {
  PRESENT       // Presente
  ABSENT        // Ausente
  LATE          // Tardanza
  EXCUSED       // Excusa justificada
}

model AttendanceRecord {
  id                  String   @id @default(cuid())
  teacherAssignmentId String
  studentEnrollmentId String
  date                DateTime @db.Date
  status              AttendanceStatus
  observations        String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  teacherAssignment TeacherAssignment @relation(fields: [teacherAssignmentId], references: [id], onDelete: Cascade)
  studentEnrollment StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)

  @@unique([teacherAssignmentId, studentEnrollmentId, date])
  @@index([teacherAssignmentId])
  @@index([studentEnrollmentId])
  @@index([date])
}

// ==================== STUDENT OBSERVER ====================

enum ObservationType {
  POSITIVE      // Logro, reconocimiento
  NEGATIVE      // Falta, llamado de atenciÃ³n
  NEUTRAL       // ObservaciÃ³n informativa
  COMMITMENT    // Compromiso firmado
}

enum ObservationCategory {
  ACADEMIC      // AcadÃ©mico
  BEHAVIORAL    // Comportamental
  ATTENDANCE    // Asistencia
  UNIFORM       // Uniforme/presentaciÃ³n
  OTHER         // Otro
}

model StudentObservation {
  id                  String   @id @default(cuid())
  studentEnrollmentId String
  authorId            String
  date                DateTime @db.Date
  type                ObservationType
  category            ObservationCategory
  description         String
  actionTaken         String?
  parentNotified      Boolean  @default(false)
  parentNotifiedAt    DateTime?
  requiresFollowUp    Boolean  @default(false)
  followUpDate        DateTime?
  followUpNotes       String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  studentEnrollment StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  author            User              @relation(fields: [authorId], references: [id], onDelete: Restrict)

  @@index([studentEnrollmentId])
  @@index([authorId])
  @@index([date])
  @@index([type])
}

// ==================== COMMUNICATIONS ====================

enum MessageType {
  ANNOUNCEMENT    // Anuncio general
  CIRCULAR        // Circular institucional
  NOTIFICATION    // NotificaciÃ³n individual
  REMINDER        // Recordatorio
}

enum MessageStatus {
  DRAFT
  SENT
  SCHEDULED
}

model Message {
  id            String        @id @default(cuid())
  institutionId String
  authorId      String
  type          MessageType
  subject       String
  content       String
  status        MessageStatus @default(DRAFT)
  scheduledAt   DateTime?
  sentAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  institution Institution    @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  author      User           @relation(fields: [authorId], references: [id], onDelete: Restrict)
  recipients  MessageRecipient[]

  @@index([institutionId])
  @@index([authorId])
  @@index([status])
}

enum RecipientType {
  USER
  GROUP
  GRADE
  ALL_STUDENTS
  ALL_TEACHERS
  ALL_PARENTS
}

model MessageRecipient {
  id            String        @id @default(cuid())
  messageId     String
  recipientType RecipientType
  recipientId   String?
  readAt        DateTime?
  createdAt     DateTime      @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([recipientId])
}

// ============================================
// DASHBOARD - Noticias, GalerÃ­a, Eventos
// ============================================

model Announcement {
  id            String    @id @default(cuid())
  institutionId String
  title         String
  content       String
  imageUrl      String?
  priority      Int       @default(0)
  isActive      Boolean   @default(true)
  publishedAt   DateTime  @default(now())
  expiresAt     DateTime?
  authorId      String
  
  // Visibilidad por rol - JSON array de roles que pueden ver (vacÃ­o = todos)
  // Ejemplo: ["DOCENTE", "COORDINADOR"] o ["ESTUDIANTE"]
  visibleToRoles String[]  @default([])
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  author      User        @relation("AnnouncementAuthor", fields: [authorId], references: [id])

  @@index([institutionId])
  @@index([isActive])
  @@index([publishedAt])
}

model GalleryImage {
  id            String   @id @default(cuid())
  institutionId String
  title         String
  description   String?
  imageUrl      String
  category      String?
  isActive      Boolean  @default(true)
  order         Int      @default(0)
  uploadedById  String
  
  // Visibilidad por rol - array de roles que pueden ver (vacÃ­o = todos)
  visibleToRoles String[]  @default([])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  uploadedBy  User        @relation("GalleryUploader", fields: [uploadedById], references: [id])

  @@index([institutionId])
  @@index([isActive])
  @@index([category])
}

model Event {
  id            String    @id @default(cuid())
  institutionId String
  title         String
  description   String?
  eventDate     DateTime
  endDate       DateTime?
  location      String?
  eventType     String    @default("GENERAL")
  isActive      Boolean   @default(true)
  authorId      String
  
  // Visibilidad por rol - array de roles que pueden ver (vacÃ­o = todos)
  visibleToRoles String[]  @default([])
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  author      User        @relation("EventAuthor", fields: [authorId], references: [id])

  @@index([institutionId])
  @@index([eventDate])
  @@index([isActive])
}

// ============================================
// MÃ“DULO DE RECUPERACIONES ACADÃ‰MICAS
// Decreto 1290 - SIEE Colombia
// ============================================

enum RecoveryType {
  PERIOD      // RecuperaciÃ³n por perÃ­odo
  FINAL       // RecuperaciÃ³n final (plan de apoyo)
}

enum RecoveryStatus {
  PENDING           // Pendiente de iniciar
  IN_PROGRESS       // En proceso
  COMPLETED         // Completada
  APPROVED          // Aprobada
  NOT_APPROVED      // No aprobada
  CANCELLED         // Cancelada
}

enum RecoveryImpactType {
  ADJUST_TO_MINIMUM     // Ajustar hasta la nota mÃ­nima aprobatoria
  AVERAGE_WITH_ORIGINAL // Promediar con nota original
  REPLACE_IF_HIGHER     // Reemplazar solo si es mayor
  QUALITATIVE_ONLY      // Solo registro cualitativo (no afecta nota)
}

// AcademicActType movido a la secciÃ³n de enums de AÃ±o Lectivo (lÃ­nea ~102)

// ConfiguraciÃ³n institucional de recuperaciones
model RecoveryConfig {
  id                    String   @id @default(cuid())
  institutionId         String
  academicYearId        String
  
  // ConfiguraciÃ³n general
  minPassingScore       Decimal  @db.Decimal(3, 1) @default(3.0)
  
  // RecuperaciÃ³n por perÃ­odo
  periodRecoveryEnabled Boolean  @default(true)
  periodMaxScore        Decimal  @db.Decimal(3, 1) @default(3.0)
  periodImpactType      RecoveryImpactType @default(ADJUST_TO_MINIMUM)
  
  // RecuperaciÃ³n final
  finalRecoveryEnabled  Boolean  @default(true)
  finalMaxScore         Decimal  @db.Decimal(3, 1) @default(3.0)
  finalImpactType       RecoveryImpactType @default(ADJUST_TO_MINIMUM)
  maxAreasRecoverable   Int      @default(2)
  
  // Fechas de ventanas de recuperaciÃ³n
  periodRecoveryStartDate DateTime?
  periodRecoveryEndDate   DateTime?
  finalRecoveryStartDate  DateTime?
  finalRecoveryEndDate    DateTime?
  
  // Actas requeridas
  requiresAcademicCouncilAct Boolean @default(true)
  requiresPromotionAct       Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  institution  Institution  @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@unique([institutionId, academicYearId])
}

// RecuperaciÃ³n por perÃ­odo
model PeriodRecovery {
  id                    String   @id @default(cuid())
  studentEnrollmentId   String
  academicTermId        String
  subjectId             String
  
  // Nota original que generÃ³ la recuperaciÃ³n
  originalScore         Decimal  @db.Decimal(3, 1)
  
  // InformaciÃ³n de la recuperaciÃ³n
  status                RecoveryStatus @default(PENDING)
  activityDescription   String?  @db.Text
  scheduledDate         DateTime?
  completedDate         DateTime?
  
  // DimensiÃ³n reforzada
  reinforcedDimension   String?  @default("COGNITIVA")
  
  // Resultado
  recoveryScore         Decimal? @db.Decimal(3, 1)
  finalScore            Decimal? @db.Decimal(3, 1)
  impactType            RecoveryImpactType?
  
  // Evidencias y observaciones
  evidences             String?  @db.Text
  observations          String?  @db.Text
  
  // Responsables
  assignedById          String
  evaluatedById         String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentEnrollment StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  academicTerm      AcademicTerm      @relation("PeriodRecoveryTerm", fields: [academicTermId], references: [id], onDelete: Cascade)
  subject           Subject           @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  assignedBy        User              @relation("RecoveryAssignedBy", fields: [assignedById], references: [id])
  evaluatedBy       User?             @relation("RecoveryEvaluatedBy", fields: [evaluatedById], references: [id])

  @@index([studentEnrollmentId])
  @@index([academicTermId])
  @@index([status])
}

// Plan de apoyo final (recuperaciÃ³n final por Ã¡rea)
model FinalRecoveryPlan {
  id                    String   @id @default(cuid())
  studentEnrollmentId   String
  academicYearId        String
  areaId                String
  
  // Nota final del Ã¡rea que generÃ³ el plan
  originalAreaScore     Decimal  @db.Decimal(3, 1)
  
  // Estado del plan
  status                RecoveryStatus @default(PENDING)
  
  // Plan de actividades
  activities            String?  @db.Text
  objectives            String?  @db.Text
  resources             String?  @db.Text
  
  // Fechas
  startDate             DateTime?
  endDate               DateTime?
  completedDate         DateTime?
  
  // Resultado
  recoveryScore         Decimal? @db.Decimal(3, 1)
  finalAreaScore        Decimal? @db.Decimal(3, 1)
  impactType            RecoveryImpactType?
  
  // Evidencias y observaciones
  evidences             String?  @db.Text
  observations          String?  @db.Text
  
  // Responsables
  responsibleTeacherId  String
  supervisorId          String?
  
  // DecisiÃ³n final
  finalDecision         String?
  approvedById          String?
  approvalDate          DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentEnrollment  StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  academicYear       AcademicYear      @relation("FinalRecoveryYear", fields: [academicYearId], references: [id], onDelete: Cascade)
  area               Area              @relation(fields: [areaId], references: [id], onDelete: Cascade)
  responsibleTeacher User              @relation("FinalRecoveryTeacher", fields: [responsibleTeacherId], references: [id])
  supervisor         User?             @relation("FinalRecoverySupervisor", fields: [supervisorId], references: [id])
  approvedBy         User?             @relation("FinalRecoveryApprover", fields: [approvedById], references: [id])
  academicActs       AcademicAct[]

  @@index([studentEnrollmentId])
  @@index([academicYearId])
  @@index([status])
}

// Actas acadÃ©micas
model AcademicAct {
  id                    String   @id @default(cuid())
  institutionId         String
  academicYearId        String
  
  // Tipo y nÃºmero de acta
  actType               AcademicActType
  actNumber             String
  actDate               DateTime
  
  // Contenido
  title                 String
  content               String   @db.Text
  decisions             String?  @db.Text
  attendees             String?  @db.Text
  
  // Relaciones opcionales
  studentEnrollmentId   String?
  finalRecoveryPlanId   String?
  
  // Firmas y aprobaciÃ³n
  createdById           String
  approvedById          String?
  approvalDate          DateTime?
  
  // Documento generado
  documentUrl           String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  institution       Institution        @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  academicYear      AcademicYear       @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  studentEnrollment StudentEnrollment? @relation(fields: [studentEnrollmentId], references: [id])
  finalRecoveryPlan FinalRecoveryPlan? @relation(fields: [finalRecoveryPlanId], references: [id])
  createdBy         User               @relation("ActCreatedBy", fields: [createdById], references: [id])
  approvedBy        User?              @relation("ActApprovedBy", fields: [approvedById], references: [id])
  
  // Eventos de matrÃ­cula relacionados con esta acta
  enrollmentEvents  EnrollmentEvent[]

  @@index([institutionId])
  @@index([academicYearId])
  @@index([actType])
}

// ==================== SISTEMA DE DESEMPEÃ‘OS ====================

// Dimensiones de evaluaciÃ³n (Cognitivo, Procedimental, Actitudinal)
enum PerformanceDimension {
  COGNITIVO
  PROCEDIMENTAL
  ACTITUDINAL
}

// ConfiguraciÃ³n de complementos por nivel de desempeÃ±o
model PerformanceLevelComplement {
  id            String           @id @default(cuid())
  institutionId String
  level         PerformanceLevel
  complement    String           @db.Text
  isActive      Boolean          @default(true)
  displayMode   ComplementDisplayMode @default(CONCATENATE)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@unique([institutionId, level])
}

enum ComplementDisplayMode {
  CONCATENATE      // Se concatena al texto base
  SEPARATE_LINE    // Se muestra en lÃ­nea separada
}

// ConfiguraciÃ³n del mÃ³dulo de desempeÃ±os por instituciÃ³n
model PerformanceConfig {
  id                      String   @id @default(cuid())
  institutionId           String   @unique
  isEnabled               Boolean  @default(true)
  showByDimension         Boolean  @default(true)   // true = por dimensiÃ³n, false = consolidado
  allowManualEdit         Boolean  @default(false)  // Permitir ediciÃ³n manual excepcional
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
}

// DesempeÃ±o base registrado por el docente (por asignatura, perÃ­odo y dimensiÃ³n)
model SubjectPerformance {
  id                    String               @id @default(cuid())
  teacherAssignmentId   String
  academicTermId        String
  dimension             PerformanceDimension
  baseDescription       String               @db.Text
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  teacherAssignment TeacherAssignment @relation(fields: [teacherAssignmentId], references: [id], onDelete: Cascade)
  academicTerm      AcademicTerm      @relation(fields: [academicTermId], references: [id], onDelete: Cascade)

  @@unique([teacherAssignmentId, academicTermId, dimension])
  @@index([teacherAssignmentId])
  @@index([academicTermId])
}

// Registro de ediciones manuales (auditorÃ­a)
model PerformanceManualEdit {
  id                    String               @id @default(cuid())
  studentEnrollmentId   String
  academicTermId        String
  subjectId             String
  dimension             PerformanceDimension
  originalText          String               @db.Text
  editedText            String               @db.Text
  reason                String
  editedById            String
  createdAt             DateTime             @default(now())

  studentEnrollment StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  academicTerm      AcademicTerm      @relation(fields: [academicTermId], references: [id], onDelete: Cascade)
  subject           Subject           @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  editedBy          User              @relation("PerformanceEditedBy", fields: [editedById], references: [id])

  @@index([studentEnrollmentId])
  @@index([academicTermId])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA DE LOGROS Y JUICIOS VALORATIVOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ConfiguraciÃ³n institucional del mÃ³dulo de logros
model AchievementConfig {
  id                        String   @id @default(cuid())
  institutionId             String   @unique
  
  // ConfiguraciÃ³n de logros por perÃ­odo
  achievementsPerPeriod     Int      @default(1)        // NÃºmero de logros acadÃ©micos por perÃ­odo
  usePromotionalAchievement Boolean  @default(true)     // Usar logro promocional (fin de aÃ±o)
  
  // ConfiguraciÃ³n de logro actitudinal
  useAttitudinalAchievement Boolean  @default(false)    // Habilitar logro actitudinal
  attitudinalMode           AttitudinalAchievementMode @default(GENERAL_PER_PERIOD) // Modo del logro actitudinal
  
  // ConfiguraciÃ³n de juicios valorativos
  useValueJudgments         Boolean  @default(true)     // Habilitar juicios valorativos por desempeÃ±o
  
  // ConfiguraciÃ³n de visualizaciÃ³n en boletÃ­n
  displayMode               AchievementDisplayMode @default(SEPARATE) // CÃ³mo mostrar logros en boletÃ­n
  displayFormat             AchievementDisplayFormat @default(LIST)   // Formato de visualizaciÃ³n
  judgmentPosition          JudgmentPosition @default(END_OF_EACH)    // PosiciÃ³n del juicio valorativo
  
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  institution               Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  valueJudgmentTemplates    ValueJudgmentTemplate[]
}

enum AchievementDisplayMode {
  SEPARATE      // AcadÃ©mico y Actitudinal separados
  COMBINED      // Todo en un solo texto combinado
}

enum AchievementDisplayFormat {
  LIST          // Lista numerada
  PARAGRAPH     // PÃ¡rrafo continuo
}

enum JudgmentPosition {
  END_OF_EACH   // Al final de cada logro
  END_OF_ALL    // Al final de todos los logros
  NONE          // No mostrar
}

enum AttitudinalAchievementMode {
  GENERAL_PER_PERIOD        // Un logro actitudinal general por perÃ­odo
  PER_ACADEMIC_ACHIEVEMENT  // Un logro actitudinal por cada logro acadÃ©mico
}

// Plantillas de juicios valorativos por nivel de desempeÃ±o
model ValueJudgmentTemplate {
  id                  String           @id @default(cuid())
  achievementConfigId String
  level               PerformanceLevel
  template            String           @db.Text  // Texto sugerido para este nivel
  isActive            Boolean          @default(true)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  achievementConfig   AchievementConfig @relation(fields: [achievementConfigId], references: [id], onDelete: Cascade)

  @@unique([achievementConfigId, level])
}

// Logro acadÃ©mico definido por el docente (por asignatura, perÃ­odo)
model Achievement {
  id                    String          @id @default(cuid())
  code                  String          // CÃ³digo interno (ej: LOG-MAT-P1-01)
  teacherAssignmentId   String
  academicTermId        String
  orderNumber           Int             @default(1)  // NÃºmero de logro (1, 2, 3...)
  achievementType       AchievementType @default(ACADEMIC) // Tipo de logro
  baseDescription       String          @db.Text     // Texto base del logro
  isPromotional         Boolean         @default(false) // Es logro promocional (fin de aÃ±o)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  teacherAssignment     TeacherAssignment @relation(fields: [teacherAssignmentId], references: [id], onDelete: Cascade)
  academicTerm          AcademicTerm      @relation(fields: [academicTermId], references: [id], onDelete: Cascade)
  studentAchievements   StudentAchievement[]
  attitudinalAchievements AttitudinalAchievement[]

  @@unique([teacherAssignmentId, academicTermId, orderNumber, isPromotional])
  @@unique([code, teacherAssignmentId]) // CÃ³digo Ãºnico por asignaciÃ³n
  @@index([teacherAssignmentId])
  @@index([academicTermId])
  @@index([code])
}

enum AchievementType {
  ACADEMIC      // Logro acadÃ©mico
  ATTITUDINAL   // Logro actitudinal
  PROMOTIONAL   // Logro promocional
}

// Logro actitudinal (puede ser general o asociado a un logro acadÃ©mico)
model AttitudinalAchievement {
  id                    String       @id @default(cuid())
  teacherAssignmentId   String
  academicTermId        String
  achievementId         String?      // NULL = general por perÃ­odo, NOT NULL = asociado a logro acadÃ©mico
  description           String       @db.Text
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  teacherAssignment     TeacherAssignment @relation(fields: [teacherAssignmentId], references: [id], onDelete: Cascade)
  academicTerm          AcademicTerm      @relation(fields: [academicTermId], references: [id], onDelete: Cascade)
  achievement           Achievement?      @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@index([teacherAssignmentId])
  @@index([academicTermId])
}

// Logro del estudiante (con nota, texto adaptado y juicio valorativo)
model StudentAchievement {
  id                    String           @id @default(cuid())
  studentEnrollmentId   String
  achievementId         String
  
  // El desempeÃ±o se calcula automÃ¡ticamente desde la nota
  performanceLevel      PerformanceLevel // BAJO, BASICO, ALTO, SUPERIOR (calculado)
  
  // Textos sugeridos por el sistema, editables por el docente
  suggestedText         String?          @db.Text  // Texto sugerido segÃºn desempeÃ±o
  approvedText          String?          @db.Text  // Texto aprobado por el docente
  isTextApproved        Boolean          @default(false)
  
  // Juicio valorativo
  suggestedJudgment     String?          @db.Text  // Juicio sugerido segÃºn desempeÃ±o
  approvedJudgment      String?          @db.Text  // Juicio aprobado por el docente
  isJudgmentApproved    Boolean          @default(false)
  
  // Logro actitudinal combinado (si aplica)
  attitudinalText       String?          @db.Text
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  approvedAt            DateTime?        // Fecha de aprobaciÃ³n final
  approvedById          String?          // QuiÃ©n aprobÃ³

  studentEnrollment     StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  achievement           Achievement       @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  approvedBy            User?             @relation("AchievementApprovedBy", fields: [approvedById], references: [id])

  @@unique([studentEnrollmentId, achievementId])
  @@index([studentEnrollmentId])
  @@index([achievementId])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA DE PERMISOS GRANULARES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// CatÃ¡logo maestro de permisos (definido por el sistema)
model Permission {
  id          String   @id @default(cuid())
  code        String   @unique  // Ej: "CONFIG_GRADING_EDIT_SCALE"
  module      String   // Ej: "CONFIG_INSTITUTIONAL"
  function    String   // Ej: "GRADING_SYSTEM"
  subFunction String   // Ej: "EDIT_SCALE"
  name        String   // Ej: "Cambiar escala de notas"
  description String?
  createdAt   DateTime @default(now())
  
  rolePermissions RoleBasePermission[]
  userPermissions UserExtraPermission[]
  auditLogs       PermissionAuditLog[]
}

// Permisos base por rol (FIJOS - definidos por el sistema, no editables por Admin)
model RoleBasePermission {
  id           String     @id @default(cuid())
  role         String     // "ADMIN_INSTITUTIONAL", "RECTOR", "COORDINADOR", "DOCENTE"
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  
  @@unique([role, permissionId])
  @@index([role])
}

// Permisos extra por usuario (temporales o permanentes)
model UserExtraPermission {
  id           String      @id @default(cuid())
  userId       String
  user         User        @relation("UserExtraPermissions", fields: [userId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission  @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  // QuiÃ©n otorgÃ³ el permiso
  grantedById  String
  grantedBy    User        @relation("GrantedPermissions", fields: [grantedById], references: [id])
  grantedAt    DateTime    @default(now())
  
  // Vigencia (null = permanente)
  validFrom    DateTime    @default(now())
  validTo      DateTime?   // null = sin expiraciÃ³n
  
  // Metadata
  reason       String      // Obligatorio para auditorÃ­a
  isActive     Boolean     @default(true)
  revokedAt    DateTime?
  revokedById  String?
  revokedBy    User?       @relation("RevokedPermissions", fields: [revokedById], references: [id])
  revokeReason String?
  
  @@unique([userId, permissionId])
  @@index([userId])
  @@index([validTo])
}

// Tipos de acciones de auditorÃ­a
enum PermissionAuditAction {
  GRANT           // Otorgar permiso extra
  REVOKE          // Revocar permiso extra
  EXPIRE          // ExpiraciÃ³n automÃ¡tica
  ROLE_ASSIGN     // Asignar rol a usuario
  ROLE_REMOVE     // Quitar rol a usuario
  RULE_CHANGE     // Cambio de reglas acadÃ©micas
  PERIOD_OPEN     // Apertura de perÃ­odo
  PERIOD_CLOSE    // Cierre de perÃ­odo
  WINDOW_OPEN     // Apertura de ventana
  WINDOW_CLOSE    // Cierre de ventana
}

// AuditorÃ­a de permisos (OBLIGATORIA)
model PermissionAuditLog {
  id            String                @id @default(cuid())
  institutionId String
  institution   Institution           @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  
  // AcciÃ³n realizada
  action        PermissionAuditAction
  
  // Usuario afectado
  targetUserId  String
  targetUser    User                  @relation("AuditTarget", fields: [targetUserId], references: [id])
  
  // Permiso afectado (opcional, para cambios de rol es null)
  permissionId  String?
  permission    Permission?           @relation(fields: [permissionId], references: [id])
  
  // Para cambios de rol
  oldRole       String?
  newRole       String?
  
  // QuiÃ©n realizÃ³ la acciÃ³n
  performedById String
  performedBy   User                  @relation("AuditPerformer", fields: [performedById], references: [id])
  performedAt   DateTime              @default(now())
  
  // Detalles
  reason        String?
  metadata      Json?                 // Datos adicionales (fechas, configuraciones, etc.)
  ipAddress     String?
  
  @@index([institutionId, performedAt])
  @@index([targetUserId])
  @@index([action])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO DE ELECCIONES ESCOLARES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Proceso electoral (agrupa todas las elecciones de un perÃ­odo)
model ElectionProcess {
  id              String   @id @default(cuid())
  institutionId   String
  academicYearId  String
  
  name            String   // "Elecciones Gobierno Escolar 2026"
  description     String?
  
  // Fechas del proceso general
  registrationStart DateTime  // Inicio inscripciÃ³n candidatos
  registrationEnd   DateTime  // Fin inscripciÃ³n candidatos
  campaignStart     DateTime  // Inicio campaÃ±a
  campaignEnd       DateTime  // Fin campaÃ±a
  votingStart       DateTime  // Inicio votaciÃ³n
  votingEnd         DateTime  // Fin votaciÃ³n
  
  status          ElectionProcessStatus @default(DRAFT)
  
  // ConfiguraciÃ³n de cargos habilitados
  enablePersonero           Boolean @default(true)
  enableContralor           Boolean @default(true)
  enableRepresentanteGrado  Boolean @default(true)
  enableRepresentanteCurso  Boolean @default(true)
  
  // ConfiguraciÃ³n de votaciÃ³n
  allowBlankVote  Boolean @default(true)
  
  createdById     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  institution     Institution   @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  academicYear    AcademicYear  @relation(fields: [academicYearId], references: [id])
  createdBy       User          @relation("ElectionProcessCreatedBy", fields: [createdById], references: [id])
  elections       Election[]
  
  @@unique([institutionId, academicYearId])
}

enum ElectionProcessStatus {
  DRAFT           // Borrador
  REGISTRATION    // InscripciÃ³n de candidatos
  CAMPAIGN        // CampaÃ±a electoral
  VOTING          // VotaciÃ³n activa
  CLOSED          // Cerrada (resultados disponibles)
  CANCELLED       // Anulada
}

// ElecciÃ³n especÃ­fica (Personero, Contralor, Rep. Grado X, Rep. Curso XA)
model Election {
  id                String   @id @default(cuid())
  electionProcessId String
  
  type              ElectionType
  
  // Para representantes de grado/curso, especificar cuÃ¡l
  gradeId           String?  // Si es REPRESENTANTE_GRADO
  groupId           String?  // Si es REPRESENTANTE_CURSO
  
  // QuiÃ©nes pueden votar (si es null, todos los estudiantes activos)
  // Para personero/contralor: todos
  // Para rep. grado: estudiantes del grado
  // Para rep. curso: estudiantes del curso
  
  status            ElectionStatus @default(ACTIVE)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  electionProcess   ElectionProcess @relation(fields: [electionProcessId], references: [id], onDelete: Cascade)
  grade             Grade?          @relation(fields: [gradeId], references: [id])
  group             Group?          @relation(fields: [groupId], references: [id])
  candidates        Candidate[]
  votes             Vote[]
  results           ElectionResult[]
  
  @@unique([electionProcessId, type, gradeId, groupId])
}

enum ElectionType {
  PERSONERO             // Personero estudiantil (toda la instituciÃ³n)
  CONTRALOR             // Contralor estudiantil (toda la instituciÃ³n)
  REPRESENTANTE_GRADO   // Representante de grado (por grado)
  REPRESENTANTE_CURSO   // Representante de curso (por grupo)
}

enum ElectionStatus {
  ACTIVE      // Activa
  CANCELLED   // Anulada
}

// Candidato inscrito
model Candidate {
  id            String   @id @default(cuid())
  electionId    String
  studentId     String
  
  // InformaciÃ³n de campaÃ±a
  slogan        String?           // Eslogan de campaÃ±a
  proposals     String?           // Propuestas (texto o HTML)
  photo         String?           // Foto de campaÃ±a (URL)
  color         String?           // Color de campaÃ±a (hex)
  ballotNumber  Int?              // NÃºmero en el tarjetÃ³n
  
  // Estado de aprobaciÃ³n
  status        CandidateStatus @default(PENDING)
  rejectionReason String?
  
  approvedById  String?
  approvedAt    DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  election      Election @relation(fields: [electionId], references: [id], onDelete: Cascade)
  student       Student  @relation(fields: [studentId], references: [id])
  approvedBy    User?    @relation("CandidateApprovedBy", fields: [approvedById], references: [id])
  votes         Vote[]
  result        ElectionResult?
  
  @@unique([electionId, studentId])
}

enum CandidateStatus {
  PENDING   // Pendiente de aprobaciÃ³n
  APPROVED  // Aprobado
  REJECTED  // Rechazado
}

// Voto emitido
model Vote {
  id            String   @id @default(cuid())
  electionId    String
  
  // QuiÃ©n votÃ³ (para evitar duplicados, NO se guarda por quiÃ©n votÃ³ pÃºblicamente)
  voterId       String   // ID del estudiante que votÃ³
  
  // Por quiÃ©n votÃ³ (null = voto en blanco)
  candidateId   String?
  
  votedAt       DateTime @default(now())

  election      Election   @relation(fields: [electionId], references: [id], onDelete: Cascade)
  voter         Student    @relation("VoterVotes", fields: [voterId], references: [id])
  candidate     Candidate? @relation(fields: [candidateId], references: [id])
  
  @@unique([electionId, voterId]) // Un voto por estudiante por elecciÃ³n
  @@index([electionId])
}

// Resultado de elecciÃ³n (calculado al cerrar)
model ElectionResult {
  id            String   @id @default(cuid())
  electionId    String
  candidateId   String?  @unique // null = votos en blanco
  
  votes         Int      // Total de votos
  percentage    Float    // Porcentaje
  position      Int      // PosiciÃ³n (1Â°, 2Â°, 3Â°...)
  isWinner      Boolean  @default(false)
  
  calculatedAt  DateTime @default(now())

  election      Election   @relation(fields: [electionId], references: [id], onDelete: Cascade)
  candidate     Candidate? @relation(fields: [candidateId], references: [id])
  
  @@unique([electionId, candidateId])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO DE PAGOS Y EVENTOS FINANCIEROS (OPCIONAL)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Concepto de pago (configurable por instituciÃ³n)
model PaymentConcept {
  id            String   @id @default(cuid())
  institutionId String
  name          String   // "MatrÃ­cula", "PensiÃ³n", "Derecho a grado", etc.
  description   String?
  defaultAmount Decimal? @db.Decimal(12, 2) // Monto base sugerido
  isRecurrent   Boolean  @default(false)    // Mensual, anual, etc.
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution   Institution    @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  events        PaymentEvent[]

  @@unique([institutionId, name])
  @@index([institutionId])
}

// Evento de pago (rifa, bingo, prueba semestral, graduaciÃ³n, etc.)
model PaymentEvent {
  id            String       @id @default(cuid())
  institutionId String
  conceptId     String?
  academicYearId String?     // AÃ±o lectivo asociado (opcional)
  
  name          String       // "Rifa NavideÃ±a 2026", "Derecho a Grado 11Â°"
  description   String?
  amount        Decimal      @db.Decimal(12, 2)  // Monto a pagar
  dueDate       DateTime?    // Fecha lÃ­mite de pago
  
  // Alcance del evento
  scope         PaymentScope @default(INSTITUTION)
  scopeFilter   Json?        // { gradeIds: [], groupIds: [], shiftId: "" }
  
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  createdById   String?

  institution   Institution     @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  concept       PaymentConcept? @relation(fields: [conceptId], references: [id])
  academicYear  AcademicYear?   @relation(fields: [academicYearId], references: [id])
  createdBy     User?           @relation("PaymentEventCreatedBy", fields: [createdById], references: [id])
  payments      StudentPayment[]

  @@index([institutionId])
  @@index([academicYearId])
}

enum PaymentScope {
  INSTITUTION   // Toda la instituciÃ³n
  SHIFT         // Por jornada
  GRADE         // Por grado
  GROUP         // Por grupo/curso
  INDIVIDUAL    // Estudiantes especÃ­ficos
}

// Pago de estudiante (relaciÃ³n estudiante-evento)
model StudentPayment {
  id            String        @id @default(cuid())
  studentId     String
  eventId       String
  
  // Montos
  totalAmount   Decimal       @db.Decimal(12, 2)  // Monto total a pagar
  paidAmount    Decimal       @default(0) @db.Decimal(12, 2) // Monto pagado
  
  // Estado
  status        PaymentStatus @default(PENDING)
  
  // Descuentos/Exenciones
  discountAmount Decimal?     @db.Decimal(12, 2)
  discountReason String?
  
  observations  String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  student       Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  event         PaymentEvent     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  transactions  PaymentTransaction[]

  @@unique([studentId, eventId])
  @@index([studentId])
  @@index([eventId])
  @@index([status])
}

enum PaymentStatus {
  PENDING   // Sin pagar
  PARTIAL   // Pago parcial
  PAID      // Pagado completo
  EXEMPT    // Exento (beca, descuento 100%)
  OVERDUE   // Vencido
}

// TransacciÃ³n de pago (abonos)
model PaymentTransaction {
  id               String   @id @default(cuid())
  studentPaymentId String
  
  amount           Decimal  @db.Decimal(12, 2)
  paymentMethod    String?  // Efectivo, transferencia, PSE, etc.
  reference        String?  // NÃºmero de recibo/comprobante
  
  observations     String?
  receivedById     String
  receivedAt       DateTime @default(now())

  studentPayment   StudentPayment @relation(fields: [studentPaymentId], references: [id], onDelete: Cascade)
  receivedBy       User           @relation("PaymentReceivedBy", fields: [receivedById], references: [id])

  @@index([studentPaymentId])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOCUMENTOS INSTITUCIONALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

enum InstitutionalDocumentCategory {
  MANUAL           // Manuales de convivencia, procedimientos
  REGLAMENTO       // Reglamentos institucionales
  FORMATO          // Formatos y plantillas
  CIRCULAR         // Circulares informativas
  PEI              // Proyecto Educativo Institucional
  SIEE             // Sistema Institucional de EvaluaciÃ³n
  OTRO             // Otros documentos
}

model InstitutionalDocument {
  id            String   @id @default(cuid())
  institutionId String
  
  title         String
  description   String?
  category      InstitutionalDocumentCategory
  
  // Archivo
  fileUrl       String
  fileName      String
  fileSize      Int      // Bytes
  mimeType      String
  
  // Control
  isActive      Boolean  @default(true)
  uploadedById  String
  
  // Visibilidad por rol (vacÃ­o = todos pueden ver)
  visibleToRoles String[] @default([])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  uploadedBy    User        @relation("DocumentUploader", fields: [uploadedById], references: [id])

  @@index([institutionId])
  @@index([category])
  @@index([isActive])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTIÃ“N DE TAREAS DOCENTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

enum ManagementArea {
  ACADEMICA        // GestiÃ³n AcadÃ©mica
  DIRECTIVA        // GestiÃ³n Directiva
  COMUNITARIA      // GestiÃ³n Comunitaria
  ADMINISTRATIVA   // GestiÃ³n Administrativa
}

enum TaskPriority {
  BAJA
  NORMAL
  ALTA
  URGENTE
}

enum TaskCategory {
  PLANEACION       // PlaneaciÃ³n curricular
  SEGUIMIENTO      // Seguimiento acadÃ©mico
  EVIDENCIA        // RecolecciÃ³n de evidencias
  REUNION          // Reuniones
  CAPACITACION     // Capacitaciones
  PROYECTO         // Proyectos institucionales
  OTRO             // Otros
}

enum TaskAssignmentStatus {
  PENDING          // Pendiente
  IN_PROGRESS      // En progreso
  SUBMITTED        // Entregada (esperando verificaciÃ³n)
  APPROVED         // Aprobada
  REJECTED         // Rechazada
  CANCELLED        // Cancelada
}

// LÃ­der de gestiÃ³n (docente con rol de liderazgo en un Ã¡rea)
model ManagementLeader {
  id            String         @id @default(cuid())
  institutionId String
  userId        String         // El docente que es lÃ­der
  area          ManagementArea
  isActive      Boolean        @default(true)
  assignedById  String         // QuiÃ©n lo nombrÃ³ lÃ­der
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  user          User        @relation("ManagementLeaderUser", fields: [userId], references: [id])
  assignedBy    User        @relation("ManagementLeaderAssigner", fields: [assignedById], references: [id])
  tasksCreated  ManagementTask[] @relation("TaskCreator")

  @@unique([institutionId, userId, area])
  @@index([institutionId])
  @@index([userId])
}

// Tarea de gestiÃ³n
model ManagementTask {
  id            String       @id @default(cuid())
  institutionId String
  
  title         String
  description   String?      @db.Text
  category      TaskCategory
  priority      TaskPriority @default(NORMAL)
  dueDate       DateTime?
  
  // QuiÃ©n creÃ³ la tarea
  createdById   String
  leaderId      String?      // Si fue creada por un lÃ­der de gestiÃ³n
  
  isActive      Boolean      @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution   Institution      @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  createdBy     User             @relation("TaskCreatedBy", fields: [createdById], references: [id])
  leader        ManagementLeader? @relation("TaskCreator", fields: [leaderId], references: [id])
  assignments   TaskAssignment[]

  @@index([institutionId])
  @@index([createdById])
  @@index([dueDate])
  @@index([priority])
}

// AsignaciÃ³n de tarea a docente
model TaskAssignment {
  id            String               @id @default(cuid())
  taskId        String
  assigneeId    String               // Docente asignado
  
  status        TaskAssignmentStatus @default(PENDING)
  
  // Respuesta del docente
  startedAt     DateTime?
  completedAt   DateTime?
  responseNote  String?              @db.Text
  
  // Evidencia (archivo)
  evidenceUrl      String?
  evidenceFileName String?
  evidenceFileSize Int?
  evidenceMimeType String?
  
  // VerificaciÃ³n por coordinador/lÃ­der
  verifiedById     String?
  verifiedAt       DateTime?
  verificationNote String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  task          ManagementTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  assignee      User           @relation("TaskAssignee", fields: [assigneeId], references: [id])
  verifiedBy    User?          @relation("TaskVerifier", fields: [verifiedById], references: [id])

  @@unique([taskId, assigneeId])
  @@index([taskId])
  @@index([assigneeId])
  @@index([status])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROL DE ALMACENAMIENTO POR INSTITUCIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model InstitutionStorageUsage {
  id            String   @id @default(cuid())
  institutionId String   @unique
  
  // Uso actual en bytes
  documentsUsage    BigInt   @default(0)  // Documentos institucionales
  evidencesUsage    BigInt   @default(0)  // Evidencias de tareas
  galleryUsage      BigInt   @default(0)  // GalerÃ­a
  otherUsage        BigInt   @default(0)  // Otros
  
  // LÃ­mites en bytes (0 = sin lÃ­mite)
  documentsLimit    BigInt   @default(524288000)  // 500 MB default
  evidencesLimit    BigInt   @default(1073741824) // 1 GB default
  galleryLimit      BigInt   @default(104857600)  // 100 MB default
  
  // Ãšltima actualizaciÃ³n
  lastCalculatedAt  DateTime @default(now())
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO FINANCIERO Y CONTABLE INSTITUCIONAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Tipo de tercero financiero
enum ThirdPartyType {
  STUDENT       // Estudiante matriculado
  TEACHER       // Docente
  GUARDIAN      // Acudiente
  GROUP         // Grupo completo (cobro masivo)
  GRADE         // Grado completo (cobro masivo)
  EXTERNAL      // Persona externa
  PROVIDER      // Proveedor (para egresos)
}

// Estado de obligaciÃ³n financiera
enum ObligationStatus {
  PENDING       // Pendiente de pago
  PARTIAL       // Pago parcial
  PAID          // Pagado completamente
  CANCELLED     // Cancelada/Anulada
  OVERDUE       // Vencida
}

// MÃ©todo de pago
enum PaymentMethod {
  CASH          // Efectivo
  TRANSFER      // Transferencia bancaria
  CARD          // Tarjeta dÃ©bito/crÃ©dito
  CHECK         // Cheque
  PSE           // PSE (Colombia)
  NEQUI         // Nequi
  DAVIPLATA     // Daviplata
  OTHER         // Otro
}

// Tipo de movimiento financiero
enum FinancialMovementType {
  INCOME        // Ingreso (recaudo)
  EXPENSE       // Egreso (gasto)
  REFUND        // DevoluciÃ³n
  ADJUSTMENT    // Ajuste contable
}

// Estado de factura
enum InvoiceStatus {
  DRAFT         // Borrador
  ISSUED        // Emitida
  PAID          // Pagada
  CANCELLED     // Anulada
}

// Tercero financiero (cliente/proveedor)
model FinancialThirdParty {
  id            String          @id @default(cuid())
  institutionId String
  
  type          ThirdPartyType
  referenceId   String?         // ID del student, teacher, group, grade, guardian
  
  // Datos del tercero (pueden venir de referencia o ser manuales)
  name          String
  document      String?
  documentType  DocumentType?
  email         String?
  phone         String?
  address       String?
  
  // Para proveedores
  businessName  String?         // RazÃ³n social
  nit           String?
  bankName      String?
  bankAccount   String?
  bankAccountType String?       // Ahorros, Corriente
  
  notes         String?         @db.Text
  isActive      Boolean         @default(true)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  institution   Institution     @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  obligations   FinancialObligation[]
  payments      FinancialPayment[]
  expenses      FinancialExpense[]
  invoices      FinancialInvoice[]

  @@unique([institutionId, type, referenceId])
  @@index([institutionId])
  @@index([type])
  @@index([referenceId])
  @@index([document])
}

// CategorÃ­a financiera (clasificaciÃ³n contable)
model FinancialCategory {
  id            String          @id @default(cuid())
  institutionId String
  
  name          String          // Eventos, Rifas, Grados, Donaciones, etc.
  description   String?
  code          String?         // CÃ³digo contable opcional
  type          FinancialMovementType @default(INCOME) // Si es para ingresos o egresos
  
  // Presupuesto anual opcional
  budgetAmount  Decimal?        @db.Decimal(15, 2)
  
  color         String?         // Color para UI
  icon          String?         // Icono para UI
  
  isActive      Boolean         @default(true)
  sortOrder     Int             @default(0)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  institution   Institution     @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  concepts      ChargeConcept[]
  expenses      FinancialExpense[]

  @@unique([institutionId, name])
  @@index([institutionId])
  @@index([type])
}

// Concepto de cobro (plantilla reutilizable)
model ChargeConcept {
  id            String          @id @default(cuid())
  institutionId String
  
  name          String          // Bingo institucional, Derecho de grado, etc.
  description   String?         @db.Text
  categoryId    String
  
  defaultAmount Decimal         @db.Decimal(15, 2)
  
  // ConfiguraciÃ³n de cobro
  isMassive     Boolean         @default(false)  // Permite asignaciÃ³n masiva
  isRecurring   Boolean         @default(false)  // Es recurrente (mensual, etc.)
  allowPartial  Boolean         @default(true)   // Permite pagos parciales
  allowDiscount Boolean         @default(true)   // Permite descuentos
  
  // Fechas de vigencia
  validFrom     DateTime?
  validUntil    DateTime?
  dueDate       DateTime?       // Fecha lÃ­mite de pago por defecto
  
  // ConfiguraciÃ³n de mora
  lateFeeType   String?         // FIXED, PERCENTAGE
  lateFeeValue  Decimal?        @db.Decimal(15, 2)
  gracePeriodDays Int?          @default(0)
  
  isActive      Boolean         @default(true)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  institution   Institution     @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  category      FinancialCategory @relation(fields: [categoryId], references: [id])
  obligations   FinancialObligation[]

  @@unique([institutionId, name])
  @@index([institutionId])
  @@index([categoryId])
}

// ObligaciÃ³n financiera (cobro asignado a tercero)
model FinancialObligation {
  id            String          @id @default(cuid())
  institutionId String
  
  thirdPartyId  String
  conceptId     String
  
  // Montos
  originalAmount Decimal        @db.Decimal(15, 2)  // Monto original
  discountAmount Decimal        @db.Decimal(15, 2) @default(0)  // Descuento aplicado
  lateFeeAmount  Decimal        @db.Decimal(15, 2) @default(0)  // Mora acumulada
  totalAmount    Decimal        @db.Decimal(15, 2)  // Total a pagar (original - descuento + mora)
  paidAmount     Decimal        @db.Decimal(15, 2) @default(0)  // Total pagado
  balance        Decimal        @db.Decimal(15, 2)  // Saldo pendiente
  
  status        ObligationStatus @default(PENDING)
  
  // Fechas
  issueDate     DateTime        @default(now())
  dueDate       DateTime?
  paidDate      DateTime?       // Fecha de pago completo
  
  // Descuento
  discountReason String?
  discountApprovedBy String?
  
  // Referencia para trazabilidad
  reference     String?         // NÃºmero de referencia Ãºnico
  notes         String?         @db.Text
  
  // AuditorÃ­a
  createdById   String?
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  institution   Institution     @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  thirdParty    FinancialThirdParty @relation(fields: [thirdPartyId], references: [id])
  concept       ChargeConcept   @relation(fields: [conceptId], references: [id])
  payments      FinancialPayment[]
  invoiceItems  FinancialInvoiceItem[]

  @@index([institutionId])
  @@index([thirdPartyId])
  @@index([conceptId])
  @@index([status])
  @@index([dueDate])
  @@index([reference])
}

// Pago/Recaudo (caja)
model FinancialPayment {
  id            String          @id @default(cuid())
  institutionId String
  
  obligationId  String?         // Puede ser pago a obligaciÃ³n especÃ­fica
  thirdPartyId  String          // QuiÃ©n paga
  
  amount        Decimal         @db.Decimal(15, 2)
  paymentMethod PaymentMethod
  
  // Detalles del pago
  receiptNumber String?         // NÃºmero de recibo
  transactionRef String?        // Referencia de transacciÃ³n (transferencia, PSE, etc.)
  
  paymentDate   DateTime        @default(now())
  
  notes         String?         @db.Text
  
  // AuditorÃ­a
  receivedById  String          // QuiÃ©n recibiÃ³ el pago
  voidedAt      DateTime?       // Si fue anulado
  voidedById    String?
  voidReason    String?
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  institution   Institution     @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  obligation    FinancialObligation? @relation(fields: [obligationId], references: [id])
  thirdParty    FinancialThirdParty @relation(fields: [thirdPartyId], references: [id])
  receivedBy    User            @relation("PaymentReceivedBy", fields: [receivedById], references: [id])
  voidedBy      User?           @relation("PaymentVoidedBy", fields: [voidedById], references: [id])

  @@index([institutionId])
  @@index([obligationId])
  @@index([thirdPartyId])
  @@index([paymentDate])
  @@index([receiptNumber])
}

// Egreso/Gasto
model FinancialExpense {
  id            String          @id @default(cuid())
  institutionId String
  
  categoryId    String
  providerId    String?         // Tercero proveedor (opcional)
  
  description   String
  amount        Decimal         @db.Decimal(15, 2)
  
  // Detalles
  expenseDate   DateTime        @default(now())
  invoiceNumber String?         // NÃºmero de factura del proveedor
  invoiceDate   DateTime?
  
  paymentMethod PaymentMethod?
  transactionRef String?
  
  // Documentos soporte
  attachmentUrl String?
  attachmentName String?
  
  notes         String?         @db.Text
  
  // AuditorÃ­a
  registeredById String
  approvedById   String?
  approvedAt     DateTime?
  
  // AnulaciÃ³n
  voidedAt      DateTime?
  voidedById    String?
  voidReason    String?
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  institution   Institution     @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  category      FinancialCategory @relation(fields: [categoryId], references: [id])
  provider      FinancialThirdParty? @relation(fields: [providerId], references: [id])
  registeredBy  User            @relation("ExpenseRegisteredBy", fields: [registeredById], references: [id])
  approvedBy    User?           @relation("ExpenseApprovedBy", fields: [approvedById], references: [id])
  voidedBy      User?           @relation("ExpenseVoidedBy", fields: [voidedById], references: [id])

  @@index([institutionId])
  @@index([categoryId])
  @@index([providerId])
  @@index([expenseDate])
}

// Factura/Comprobante
model FinancialInvoice {
  id            String          @id @default(cuid())
  institutionId String
  
  thirdPartyId  String
  
  invoiceNumber String          // NÃºmero de factura
  type          FinancialMovementType // INCOME o EXPENSE
  status        InvoiceStatus   @default(DRAFT)
  
  // Montos
  subtotal      Decimal         @db.Decimal(15, 2)
  discountTotal Decimal         @db.Decimal(15, 2) @default(0)
  taxTotal      Decimal         @db.Decimal(15, 2) @default(0)
  total         Decimal         @db.Decimal(15, 2)
  
  // Fechas
  issueDate     DateTime        @default(now())
  dueDate       DateTime?
  paidDate      DateTime?
  
  // PDF generado
  pdfUrl        String?
  pdfGeneratedAt DateTime?
  
  notes         String?         @db.Text
  
  // AuditorÃ­a
  createdById   String
  cancelledById String?
  cancelledAt   DateTime?
  cancelReason  String?
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  institution   Institution     @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  thirdParty    FinancialThirdParty @relation(fields: [thirdPartyId], references: [id])
  createdBy     User            @relation("InvoiceCreatedBy", fields: [createdById], references: [id])
  cancelledBy   User?           @relation("InvoiceCancelledBy", fields: [cancelledById], references: [id])
  items         FinancialInvoiceItem[]

  @@unique([institutionId, invoiceNumber])
  @@index([institutionId])
  @@index([thirdPartyId])
  @@index([status])
  @@index([issueDate])
}

// Ãtem de factura
model FinancialInvoiceItem {
  id            String          @id @default(cuid())
  invoiceId     String
  obligationId  String?         // Referencia a obligaciÃ³n si aplica
  
  description   String
  quantity      Int             @default(1)
  unitPrice     Decimal         @db.Decimal(15, 2)
  discount      Decimal         @db.Decimal(15, 2) @default(0)
  tax           Decimal         @db.Decimal(15, 2) @default(0)
  total         Decimal         @db.Decimal(15, 2)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  invoice       FinancialInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  obligation    FinancialObligation? @relation(fields: [obligationId], references: [id])

  @@index([invoiceId])
  @@index([obligationId])
}

// ConfiguraciÃ³n financiera de la instituciÃ³n
model FinancialSettings {
  id            String          @id @default(cuid())
  institutionId String          @unique
  
  // NumeraciÃ³n
  invoicePrefix String          @default("FAC")
  invoiceNextNumber Int         @default(1)
  receiptPrefix String          @default("REC")
  receiptNextNumber Int         @default(1)
  
  // ConfiguraciÃ³n de mora
  defaultLateFeeType String?    // FIXED, PERCENTAGE
  defaultLateFeeValue Decimal?  @db.Decimal(15, 2)
  defaultGracePeriodDays Int    @default(5)
  
  // Datos fiscales
  taxId         String?         // NIT para facturaciÃ³n
  taxRegime     String?         // RÃ©gimen tributario
  
  // Cuentas bancarias
  bankAccounts  Json?           // Array de cuentas bancarias
  
  // Notificaciones
  sendPaymentReminders Boolean  @default(true)
  reminderDaysBefore Int        @default(3)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  institution   Institution     @relation(fields: [institutionId], references: [id], onDelete: Cascade)
}

// Cierre de caja diario
model CashRegisterClose {
  id            String          @id @default(cuid())
  institutionId String
  
  closeDate     DateTime        @db.Date
  
  // Totales del dÃ­a
  cashTotal     Decimal         @db.Decimal(15, 2) @default(0)
  transferTotal Decimal         @db.Decimal(15, 2) @default(0)
  cardTotal     Decimal         @db.Decimal(15, 2) @default(0)
  otherTotal    Decimal         @db.Decimal(15, 2) @default(0)
  grandTotal    Decimal         @db.Decimal(15, 2) @default(0)
  
  // Conteo fÃ­sico (para arqueo)
  physicalCash  Decimal?        @db.Decimal(15, 2)
  difference    Decimal?        @db.Decimal(15, 2)
  
  notes         String?         @db.Text
  
  closedById    String
  closedAt      DateTime        @default(now())
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  institution   Institution     @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  closedBy      User            @relation(fields: [closedById], references: [id])

  @@unique([institutionId, closeDate])
  @@index([institutionId])
  @@index([closeDate])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO DE TIMETABLING (HORARIOS ESCOLARES)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Modo de organizaciÃ³n del horario (configurable por grado)
enum ScheduleMode {
  FIXED_TEACHER      // Docente fijo (preescolar, primaria baja): mismo docente todo el dÃ­a
  ROTATING_TEACHER   // RotaciÃ³n de docentes (4Â°-5Â° primaria, secundaria, media)
}

// Tipo de bloque de tiempo
enum TimeBlockType {
  CLASS              // Clase regular
  BREAK              // Descanso/recreo
  LUNCH              // Almuerzo
  ASSEMBLY           // FormaciÃ³n/acto cÃ­vico
  FREE               // Libre/disponible
}

// DÃ­a de la semana
enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

// Tipo de restricciÃ³n de espacio
enum RoomRestrictionType {
  PREFERRED          // Preferido (prioridad pero no exclusivo)
  EXCLUSIVE          // Exclusivo (solo esta materia puede usarlo)
}

// Bloque de tiempo (estructura de la jornada, mismos bloques aplican a todos los dÃ­as)
model TimeBlock {
  id            String        @id @default(cuid())
  institutionId String
  shiftId       String
  
  type          TimeBlockType @default(CLASS)
  startTime     String        // "07:00" formato HH:mm
  endTime       String        // "07:45" formato HH:mm
  order         Int           // Orden visual (1, 2, 3...)
  label         String?       // "Bloque 1", "Descanso", etc.
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  institution     Institution     @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  shift           Shift           @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  scheduleEntries ScheduleEntry[]

  @@unique([institutionId, shiftId, order])
  @@index([institutionId])
  @@index([shiftId])
}

// Espacio/Aula (recurso configurable, NO atado a materia por defecto)
model Room {
  id            String   @id @default(cuid())
  institutionId String
  campusId      String?
  
  name          String   // "Laboratorio de Ciencias", "Cancha", "Aula 201"
  code          String?  // CÃ³digo corto "LAB-1", "AUL-201"
  capacity      Int?     // Capacidad mÃ¡xima
  description   String?
  equipment     String[] // ["proyector", "microscopios", "computadores"]
  isReservable  Boolean  @default(true)
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution     Institution       @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  campus          Campus?           @relation(fields: [campusId], references: [id], onDelete: SetNull)
  scheduleEntries ScheduleEntry[]
  restrictions    RoomRestriction[]

  @@unique([institutionId, name])
  @@index([institutionId])
  @@index([campusId])
}

// RestricciÃ³n de espacio (OPCIONAL - la instituciÃ³n decide si activar)
model RoomRestriction {
  id        String              @id @default(cuid())
  roomId    String
  subjectId String?             // Asignatura (null = restricciÃ³n general)
  type      RoomRestrictionType @default(PREFERRED)
  
  createdAt DateTime @default(now())
  
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  subject   Subject? @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([roomId, subjectId])
}

// ConfiguraciÃ³n de horario por grado (modo configurable POR GRADO, no por nivel)
model ScheduleGradeConfig {
  id              String       @id @default(cuid())
  institutionId   String
  academicYearId  String
  gradeId         String
  
  mode            ScheduleMode @default(ROTATING_TEACHER)
  
  // Restricciones blandas (preferencias de optimizaciÃ³n)
  maxConsecutiveHours   Int?     // MÃ¡ximo horas seguidas de una misma materia
  preferDistribution    Boolean  @default(true)  // Distribuir horas en la semana
  avoidHeavyLastHours   Boolean  @default(false) // Evitar materias pesadas en Ãºltima hora
  allowDoubleBlocks     Boolean  @default(true)  // Permitir bloques dobles (lab, arte)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  institution     Institution  @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  grade           Grade        @relation(fields: [gradeId], references: [id], onDelete: Cascade)

  @@unique([institutionId, academicYearId, gradeId])
  @@index([institutionId])
  @@index([academicYearId])
}

// Disponibilidad del docente (OPCIONAL - para restricciones de horario)
model TeacherAvailability {
  id              String    @id @default(cuid())
  institutionId   String
  academicYearId  String
  teacherId       String
  
  dayOfWeek       DayOfWeek
  startTime       String    // "07:00"
  endTime         String    // "14:00"
  isAvailable     Boolean   @default(true) // true = disponible, false = no disponible
  reason          String?   // "Otra instituciÃ³n", "Permiso mÃ©dico", etc.
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  institution     Institution  @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  teacher         User         @relation("TeacherScheduleAvailability", fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([institutionId, academicYearId, teacherId, dayOfWeek, startTime])
  @@index([institutionId])
  @@index([teacherId])
  @@index([academicYearId])
}

// Entrada de horario (la celda en la grilla visual)
model ScheduleEntry {
  id                    String    @id @default(cuid())
  institutionId         String
  academicYearId        String
  groupId               String
  timeBlockId           String
  dayOfWeek             DayOfWeek
  
  // Clase regular (apunta a TeacherAssignment que ya tiene docente+materia+grupo)
  teacherAssignmentId   String?
  
  // Proyecto transversal (alternativa a clase regular)
  projectName           String?   // "Proyecto PRAE", "Proyecto de Democracia"
  projectDescription    String?
  
  // Espacio asignado (opcional, configurable)
  roomId                String?
  
  // Metadata
  notes                 String?
  color                 String?   // Color personalizado para la UI
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  institution           Institution        @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  academicYear          AcademicYear       @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  group                 Group              @relation(fields: [groupId], references: [id], onDelete: Cascade)
  timeBlock             TimeBlock          @relation(fields: [timeBlockId], references: [id], onDelete: Cascade)
  teacherAssignment     TeacherAssignment? @relation(fields: [teacherAssignmentId], references: [id], onDelete: SetNull)
  room                  Room?              @relation(fields: [roomId], references: [id], onDelete: SetNull)

  @@unique([groupId, timeBlockId, dayOfWeek]) // Un grupo: una sola entrada por bloque+dÃ­a
  @@index([institutionId])
  @@index([academicYearId])
  @@index([groupId])
  @@index([timeBlockId])
  @@index([teacherAssignmentId])
  @@index([roomId])
  @@index([dayOfWeek])
}
