generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SchoolShift {
  MORNING
  AFTERNOON
  SINGLE
  NIGHT
}

enum GradeStage {
  PREESCOLAR
  BASICA_PRIMARIA
  BASICA_SECUNDARIA
  MEDIA
}

enum DocumentType {
  TI
  CC
  CE
  PASAPORTE
  RC
  NIP
  NUIP
}

enum PerformanceLevel {
  SUPERIOR
  ALTO
  BASICO
  BAJO
}

enum AcademicTermType {
  PERIOD
  SEMESTER_EXAM
}

// ═══════════════════════════════════════════════════════════════════════════
// ENUMS PARA GESTIÓN DE AÑO LECTIVO
// ═══════════════════════════════════════════════════════════════════════════

// Estado del año académico
enum AcademicYearStatus {
  DRAFT      // En configuración - solo Admin puede editar estructura
  ACTIVE     // Activo - docentes pueden registrar notas/asistencia
  CLOSED     // Cerrado - solo lectura, histórico
}

// Tipo de calendario académico (Colombia)
enum CalendarType {
  A          // Calendario A (Feb-Nov)
  B          // Calendario B (Sep-Jun)
  FLEXIBLE   // Calendario flexible
}

// Estado de matrícula
enum EnrollmentStatus {
  ACTIVE       // Matriculado actualmente
  PROMOTED     // Promovido al siguiente grado
  REPEATED     // Repite el mismo grado
  WITHDRAWN    // Retirado
  TRANSFERRED  // Trasladado a otra institución
}

// Tipo de matrícula
enum EnrollmentType {
  NEW          // Matrícula nueva (primer ingreso)
  RENEWAL      // Renovación (estudiante antiguo)
  TRANSFER_IN  // Traslado desde otra institución
  REENTRY      // Reingreso (estuvo retirado)
}

// Tipo de evento de matrícula (auditoría)
enum EnrollmentEventType {
  CREATED              // Matrícula inicial
  GROUP_CHANGED        // Cambio de grupo/curso
  WITHDRAWN            // Retiro
  TRANSFERRED          // Traslado
  PROMOTED             // Promoción
  REPEATED             // Repitencia
  REACTIVATED          // Reingreso
  STATUS_CHANGED       // Cambio de estado genérico
  GRADE_CORRECTED      // Corrección de nota (con acta)
  PROMOTION_EXCEPTION  // Promoción excepcional (comité)
}

// Tipo de movimiento de matrícula
enum EnrollmentMovementType {
  ADMINISTRATIVE    // Cambio por razones administrativas
  ACADEMIC          // Cambio por razones académicas
}

// Tipo de acta académica
enum AcademicActType {
  GRADE_CORRECTION       // Corrección de nota
  PROMOTION_EXCEPTION    // Promoción excepcional
  ATTENDANCE_CORRECTION  // Corrección de asistencia
  ENROLLMENT_CORRECTION  // Corrección de matrícula
  COMMITTEE_DECISION     // Decisión de comité académico
  YEAR_CLOSURE           // Cierre de año lectivo
  ACADEMIC_COUNCIL       // Acta de consejo académico
  PROMOTION              // Acta de promoción
  RECOVERY_APPROVAL      // Acta de aprobación de recuperación
  FINAL_DECISION         // Acta de decisión final
}

// Modalidad de estudio
enum StudyModality {
  PRESENTIAL   // Presencial
  VIRTUAL      // Virtual
  HYBRID       // Híbrido
}

// Estado de la institución
enum InstitutionStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  INACTIVE
}

// Configuración de cálculo de áreas
enum AreaCalculationType {
  INFORMATIVE      // Solo informativa, no afecta promoción
  AVERAGE          // Promedio simple de asignaturas
  WEIGHTED         // Promedio ponderado por porcentajes
  DOMINANT         // La asignatura dominante define el área
}

// Regla de aprobación de áreas
enum AreaApprovalRule {
  AREA_AVERAGE           // Por promedio del área
  ALL_SUBJECTS_PASS      // Todas las asignaturas aprobadas
  DOMINANT_SUBJECT_PASS  // Solo importa la asignatura dominante
}

// Regla de recuperación de áreas
enum AreaRecoveryRule {
  INDIVIDUAL_SUBJECT  // Se recuperan asignaturas individuales
  FULL_AREA           // Se recupera el área completa
  CONDITIONAL         // Según reglas específicas
  NONE                // No permite recuperación
}

// Módulos disponibles en el sistema
enum SystemModule {
  ACADEMIC           // Gestión académica (notas, áreas, asignaturas)
  ENROLLMENTS        // Matrículas y gestión de estudiantes
  ATTENDANCE         // Control de asistencia
  EVALUATION         // Actividades evaluativas
  RECOVERY           // Recuperaciones
  REPORTS            // Reportes y boletines
  COMMUNICATIONS     // Mensajes, anuncios, galería
  OBSERVER           // Observador del estudiante
  PERFORMANCE        // Desempeño y estadísticas
  MEN_REPORTS        // Reportes para el MEN
  DASHBOARD          // Dashboard y analytics
  USERS              // Gestión de usuarios
  CONFIG             // Configuración institucional
}

model User {
  id             String     @id @default(cuid())
  email          String     @unique
  username       String?    @unique
  passwordHash   String
  firstName      String
  lastName       String
  documentType   DocumentType?
  documentNumber String?
  phone          String?
  birthDate      DateTime?
  isActive       Boolean    @default(true)
  isSuperAdmin   Boolean    @default(false)  // SuperAdmin del sistema
  mustChangePassword Boolean @default(false) // Forzar cambio de contraseña en primer login
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  roles              UserRole[]
  institutionUsers   InstitutionUser[]  // Relación con instituciones
  teacherAssignments TeacherAssignment[]
  studentObservations StudentObservation[]
  messages           Message[]
  announcements      Announcement[] @relation("AnnouncementAuthor")
  galleryImages      GalleryImage[] @relation("GalleryUploader")
  events             Event[]        @relation("EventAuthor")
  periodFinalGrades  PeriodFinalGrade[] @relation("PeriodGradeEnteredBy")
  
  // Recuperaciones
  periodRecoveriesAssigned  PeriodRecovery[]    @relation("RecoveryAssignedBy")
  periodRecoveriesEvaluated PeriodRecovery[]    @relation("RecoveryEvaluatedBy")
  finalRecoveriesTeacher    FinalRecoveryPlan[] @relation("FinalRecoveryTeacher")
  finalRecoveriesSupervisor FinalRecoveryPlan[] @relation("FinalRecoverySupervisor")
  finalRecoveriesApprover   FinalRecoveryPlan[] @relation("FinalRecoveryApprover")
  academicActsCreated       AcademicAct[]       @relation("ActCreatedBy")
  academicActsApproved      AcademicAct[]       @relation("ActApprovedBy")
  performanceManualEdits    PerformanceManualEdit[] @relation("PerformanceEditedBy")
  
  // Instituciones creadas por SuperAdmin
  institutionsCreated       Institution[]       @relation("InstitutionCreatedBy")
  
  // Gestión de Año Lectivo
  yearsActivated            AcademicYear[]      @relation("YearActivatedBy")
  yearsClosed               AcademicYear[]      @relation("YearClosedBy")
  enrollmentsCreated        StudentEnrollment[] @relation("EnrollmentCreatedBy")
  enrollmentEventsPerformed EnrollmentEvent[]   @relation("EnrollmentEventPerformedBy")
  
  // Sistema de permisos granulares
  extraPermissions          UserExtraPermission[] @relation("UserExtraPermissions")
  permissionsGranted        UserExtraPermission[] @relation("GrantedPermissions")
  permissionsRevoked        UserExtraPermission[] @relation("RevokedPermissions")
  auditLogsAsTarget         PermissionAuditLog[]  @relation("AuditTarget")
  auditLogsAsPerformer      PermissionAuditLog[]  @relation("AuditPerformer")
  
  // Estudiante asociado (si el usuario es un estudiante con acceso)
  studentProfile            Student?
}

model Role {
  id        String     @id @default(cuid())
  name      String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  users UserRole[]
}

model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model Institution {
  id          String            @id @default(cuid())
  name        String
  daneCode    String?           @unique
  nit         String?
  slug        String            @unique  // URL amigable para login (ej: "colegio-san-jose")
  logo        String?                    // URL del logo
  address     String?                    // Dirección de la institución
  phone       String?                    // Teléfono de contacto
  email       String?                    // Email institucional
  website     String?                    // Sitio web
  status      InstitutionStatus @default(TRIAL)
  trialEndsAt DateTime?                  // Fecha fin del período de prueba
  createdById String?                    // SuperAdmin que creó la institución
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // ═══════════════════════════════════════════════════════════════════════════
  // CONFIGURACIÓN INSTITUCIONAL (persistida en BD)
  // ═══════════════════════════════════════════════════════════════════════════
  
  // Configuración Global de Áreas
  areaCalculationType     AreaCalculationType  @default(WEIGHTED)
  areaApprovalRule        AreaApprovalRule     @default(AREA_AVERAGE)
  areaRecoveryRule        AreaRecoveryRule     @default(INDIVIDUAL_SUBJECT)
  areaFailIfAnyFails      Boolean              @default(false)  // Pierde área si cualquier asignatura pierde
  
  // Configuración del Sistema de Calificación (JSON para flexibilidad)
  gradingConfig           Json?                // Procesos evaluativos, subprocesos, ponderaciones
  
  // Niveles Académicos y sus escalas (JSON)
  academicLevelsConfig    Json?                // Niveles, escalas cualitativas/numéricas
  
  // Períodos Académicos (JSON)
  periodsConfig           Json?                // Períodos con fechas y ponderaciones

  // Relaciones
  createdBy   User?             @relation("InstitutionCreatedBy", fields: [createdById], references: [id])
  modules     InstitutionModule[]  // Módulos habilitados
  users       InstitutionUser[]    // Usuarios de esta institución
  
  campuses      Campus[]
  areas         Area[]
  academicYears AcademicYear[]
  performanceScale PerformanceScale[]
  evaluationComponents EvaluationComponent[]
  students      Student[]
  guardians     Guardian[]
  messages      Message[]
  announcements Announcement[]
  galleryImages GalleryImage[]
  events        Event[]
  recoveryConfigs RecoveryConfig[]
  academicActs    AcademicAct[]
  performanceLevelComplements PerformanceLevelComplement[]
  performanceConfig           PerformanceConfig?
  permissionAuditLogs         PermissionAuditLog[]
}

// Módulos habilitados por institución
model InstitutionModule {
  id            String       @id @default(cuid())
  institutionId String
  module        SystemModule
  isActive      Boolean      @default(true)
  activatedAt   DateTime     @default(now())
  expiresAt     DateTime?    // Fecha de expiración del módulo (si aplica)
  features      String[]     // Funcionalidades específicas habilitadas dentro del módulo
  
  institution   Institution  @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  
  @@unique([institutionId, module])
}

// Relación Usuario-Institución (un usuario puede pertenecer a varias instituciones)
model InstitutionUser {
  id            String   @id @default(cuid())
  userId        String
  institutionId String
  isAdmin       Boolean  @default(false)  // Es admin/rector de esta institución
  isActive      Boolean  @default(true)
  joinedAt      DateTime @default(now())
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  
  @@unique([userId, institutionId])
}

model Campus {
  id            String   @id @default(cuid())
  institutionId String
  name          String
  address       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  shifts      Shift[]
  groups      Group[]

  @@unique([institutionId, name])
}

model Shift {
  id        String      @id @default(cuid())
  campusId  String
  type      SchoolShift
  name      String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  campus Campus @relation(fields: [campusId], references: [id], onDelete: Cascade)
  groups Group[]

  @@unique([campusId, type])
}

model Grade {
  id        String     @id @default(cuid())
  stage     GradeStage
  number    Int?
  name      String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  groups Group[]

  @@unique([stage, name])
}

model Group {
  id        String   @id @default(cuid())
  campusId  String
  shiftId   String
  gradeId   String
  code      String?
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campus Campus @relation(fields: [campusId], references: [id], onDelete: Restrict)
  shift  Shift  @relation(fields: [shiftId], references: [id], onDelete: Restrict)
  grade  Grade  @relation(fields: [gradeId], references: [id], onDelete: Restrict)

  teacherAssignments TeacherAssignment[]
  studentEnrollments StudentEnrollment[]

  @@unique([campusId, shiftId, gradeId, name])
}

model Area {
  id            String   @id @default(cuid())
  institutionId String
  name          String
  isMandatory   Boolean  @default(false)
  calculationType AreaCalculationType @default(AVERAGE)
  customFormula String?
  order         Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  subjects    Subject[]
  finalRecoveryPlans FinalRecoveryPlan[]

  @@unique([institutionId, name])
}

model Subject {
  id          String   @id @default(cuid())
  areaId      String
  name        String
  weeklyHours Int      @default(0)
  weight      Float    @default(1.0)
  isDominant  Boolean  @default(false)  // Si es la asignatura dominante del área
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  area              Area                @relation(fields: [areaId], references: [id], onDelete: Cascade)
  teacherAssignments TeacherAssignment[]
  periodFinalGrades PeriodFinalGrade[]
  periodRecoveries  PeriodRecovery[]
  performanceManualEdits PerformanceManualEdit[]

  @@unique([areaId, name])
}

model AcademicYear {
  id            String             @id @default(cuid())
  institutionId String
  year          Int
  name          String?            // "Año Lectivo 2025"
  startDate     DateTime?
  endDate       DateTime?
  status        AcademicYearStatus @default(ACTIVE)
  // isCurrent es derivado: isCurrent = (status === ACTIVE)
  // Solo puede haber 1 ACTIVE por institución (validar en código)
  
  // Auditoría de cambios de estado
  activatedAt   DateTime?
  activatedById String?
  closedAt      DateTime?
  closedById    String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution       Institution        @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  activatedBy       User?              @relation("YearActivatedBy", fields: [activatedById], references: [id])
  closedBy          User?              @relation("YearClosedBy", fields: [closedById], references: [id])
  
  // Calendario académico
  calendar          AcademicCalendar?
  
  // Relaciones académicas
  periods           Period[]
  terms             AcademicTerm[]
  teacherAssignments TeacherAssignment[]
  studentEnrollments StudentEnrollment[]
  recoveryConfigs    RecoveryConfig[]
  finalRecoveryPlans FinalRecoveryPlan[] @relation("FinalRecoveryYear")
  academicActs       AcademicAct[]

  @@unique([institutionId, year])
}

// ═══════════════════════════════════════════════════════════════════════════
// CALENDARIO ACADÉMICO (Obligatorio en Colombia)
// ═══════════════════════════════════════════════════════════════════════════

model AcademicCalendar {
  id              String        @id @default(cuid())
  academicYearId  String        @unique
  type            CalendarType  @default(A) // A, B, Flexible
  
  // Información del calendario
  totalWeeks      Int           @default(40) // Semanas lectivas
  totalHours      Int           @default(800) // Horas totales
  classStartDate  DateTime?     // Inicio de clases
  classEndDate    DateTime?     // Fin de clases
  
  // Semanas de desarrollo institucional
  developmentWeeks Int          @default(5)
  
  // Vacaciones y recesos (JSON array)
  vacations       Json?         // [{ name, startDate, endDate }]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  academicYear    AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
}

model Period {
  id             String   @id @default(cuid())
  academicYearId String
  name           String
  order          Int
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@unique([academicYearId, order])
}

model AcademicTerm {
  id             String           @id @default(cuid())
  academicYearId String
  type           AcademicTermType
  name           String
  order          Int
  weightPercentage Int
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  evaluationPlans EvaluationPlan[]
  evaluativeActivities EvaluativeActivity[]
  preventiveCutConfig PreventiveCutConfig?
  preventiveAlerts PreventiveAlert[]
  periodFinalGrades PeriodFinalGrade[]
  partialGrades PartialGrade[]
  periodRecoveries  PeriodRecovery[] @relation("PeriodRecoveryTerm")
  subjectPerformances SubjectPerformance[]
  performanceManualEdits PerformanceManualEdit[]
  gradingPeriodConfig GradingPeriodConfig?
  recoveryPeriodConfig RecoveryPeriodConfig? @relation("RecoveryPeriodConfig")

  @@unique([academicYearId, order])
}

// Configuración de ventana de calificaciones por período
model GradingPeriodConfig {
  id              String    @id @default(cuid())
  academicTermId  String    @unique
  isOpen          Boolean   @default(false)
  openDate        DateTime?
  closeDate       DateTime?
  allowLateEntry  Boolean   @default(false)
  lateEntryDays   Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  academicTerm AcademicTerm @relation(fields: [academicTermId], references: [id], onDelete: Cascade)
}

// Configuración de ventana de recuperaciones por período
model RecoveryPeriodConfig {
  id              String    @id @default(cuid())
  academicTermId  String    @unique
  isOpen          Boolean   @default(false)
  openDate        DateTime?
  closeDate       DateTime?
  allowLateEntry  Boolean   @default(false)
  lateEntryDays   Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  academicTerm AcademicTerm @relation("RecoveryPeriodConfig", fields: [academicTermId], references: [id], onDelete: Cascade)
}

model TeacherAssignment {
  id            String   @id @default(cuid())
  academicYearId String
  groupId       String
  subjectId     String
  teacherId     String
  weeklyHours   Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  group        Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  subject      Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher      User         @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  evaluativeActivities EvaluativeActivity[]
  evaluationPlans EvaluationPlan[]
  preventiveAlerts PreventiveAlert[]
  attendanceRecords AttendanceRecord[]
  subjectPerformances SubjectPerformance[]
  partialGrades PartialGrade[]

  @@unique([academicYearId, groupId, subjectId, teacherId])
}

model PerformanceScale {
  id            String           @id @default(cuid())
  institutionId String
  level         PerformanceLevel
  minScore      Decimal
  maxScore      Decimal
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@unique([institutionId, level])
}

model EvaluativeActivity {
  id                 String   @id @default(cuid())
  teacherAssignmentId String
  academicTermId     String
  evaluationPlanId   String
  componentId        String
  name               String
  dueDate            DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  teacherAssignment TeacherAssignment @relation(fields: [teacherAssignmentId], references: [id], onDelete: Cascade)
  academicTerm      AcademicTerm      @relation(fields: [academicTermId], references: [id], onDelete: Cascade)
  evaluationPlan     EvaluationPlan   @relation(fields: [evaluationPlanId], references: [id], onDelete: Cascade)
  component          EvaluationComponent @relation(fields: [componentId], references: [id], onDelete: Restrict)
  studentGrades      StudentGrade[]

  @@index([teacherAssignmentId])
  @@index([academicTermId])
  @@index([evaluationPlanId])
  @@index([componentId])
}

model EvaluationPlan {
  id                 String   @id @default(cuid())
  teacherAssignmentId String
  academicTermId     String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  teacherAssignment TeacherAssignment @relation(fields: [teacherAssignmentId], references: [id], onDelete: Cascade)
  academicTerm      AcademicTerm      @relation(fields: [academicTermId], references: [id], onDelete: Cascade)

  components EvaluationPlanComponentWeight[]
  activities EvaluativeActivity[]

  @@unique([teacherAssignmentId, academicTermId])
}

model EvaluationComponent {
  id              String   @id @default(cuid())
  institutionId   String
  parentId        String?
  code            String
  name            String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  parent      EvaluationComponent? @relation("EvalComponentHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children    EvaluationComponent[] @relation("EvalComponentHierarchy")

  planWeights EvaluationPlanComponentWeight[]
  activities  EvaluativeActivity[]

  @@unique([institutionId, code])
}

model EvaluationPlanComponentWeight {
  id               String   @id @default(cuid())
  evaluationPlanId String
  componentId      String
  percentage       Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  evaluationPlan EvaluationPlan @relation(fields: [evaluationPlanId], references: [id], onDelete: Cascade)
  component      EvaluationComponent @relation(fields: [componentId], references: [id], onDelete: Restrict)

  @@unique([evaluationPlanId, componentId])
}

model Student {
  id            String   @id @default(cuid())
  institutionId String
  userId        String?  @unique  // Usuario opcional para acceso al sistema
  
  // Información básica
  documentType  String
  documentNumber String
  firstName     String
  secondName    String?
  lastName      String
  secondLastName String?
  birthDate     DateTime?
  birthPlace    String?
  gender        String?
  email         String?
  phone         String?
  address       String?
  neighborhood  String?
  city          String?
  
  // Información médica
  bloodType     String?
  eps           String?
  allergies     String?
  medicalConditions String?
  medications   String?
  emergencyContact String?
  emergencyPhone String?
  
  // Información socioeconómica (para reportes MEN)
  stratum       Int?
  sisbenLevel   String?
  ethnicity     String?
  displacement  Boolean  @default(false)
  disability    String?
  disabilityType String?
  
  // Información adicional
  previousSchool String?
  photo         String?
  observations  String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  user          User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  enrollments   StudentEnrollment[]
  guardians     StudentGuardian[]

  @@unique([institutionId, documentNumber])
}

// ═══════════════════════════════════════════════════════════════════════════
// ACUDIENTES / PADRES DE FAMILIA
// ═══════════════════════════════════════════════════════════════════════════

model Guardian {
  id              String   @id @default(cuid())
  institutionId   String
  
  // Información básica
  documentType    String
  documentNumber  String
  firstName       String
  secondName      String?
  lastName        String
  secondLastName  String?
  
  // Contacto
  phone           String
  alternatePhone  String?
  email           String?
  address         String?
  neighborhood    String?
  city            String?
  
  // Información laboral
  occupation      String?
  workplace       String?
  workPhone       String?
  workAddress     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  institution     Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  students        StudentGuardian[]

  @@unique([institutionId, documentNumber])
}

model StudentGuardian {
  id          String   @id @default(cuid())
  studentId   String
  guardianId  String
  
  // Tipo de relación
  relationship GuardianRelationship
  isPrimary   Boolean  @default(false)
  canPickUp   Boolean  @default(true)
  isEmergencyContact Boolean @default(false)
  
  // Permisos
  receivesNotifications Boolean @default(true)
  receivesGrades Boolean @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  guardian    Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)

  @@unique([studentId, guardianId])
}

enum GuardianRelationship {
  FATHER
  MOTHER
  STEPFATHER
  STEPMOTHER
  GRANDFATHER
  GRANDMOTHER
  UNCLE
  AUNT
  SIBLING
  LEGAL_GUARDIAN
  OTHER
}

model StudentEnrollment {
  id              String           @id @default(cuid())
  studentId       String
  academicYearId  String
  groupId         String
  
  // Tipo y estado de matrícula
  enrollmentType  EnrollmentType   @default(NEW)
  status          EnrollmentStatus @default(ACTIVE)
  
  // Jornada y modalidad
  shift           SchoolShift?     // Jornada: Mañana, Tarde, Única, Noche
  modality        StudyModality    @default(PRESENTIAL)
  
  // Fechas
  enrollmentDate  DateTime         @default(now())
  withdrawalDate  DateTime?        // Fecha de retiro si aplica
  withdrawalReason String?         // Motivo del retiro
  
  // Trazabilidad de promoción
  promotedFromId  String?  @unique // Matrícula del año anterior (1:1)
  
  // Observaciones y auditoría
  observations    String?          // Observaciones de matrícula
  enrolledById    String?          // Quién realizó la matrícula
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  student         Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  academicYear    AcademicYear     @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  group           Group            @relation(fields: [groupId], references: [id], onDelete: Restrict)
  enrolledBy      User?            @relation("EnrollmentCreatedBy", fields: [enrolledById], references: [id])
  
  // Trazabilidad de promoción (self-relation 1:1)
  promotedFrom    StudentEnrollment? @relation("EnrollmentPromotion", fields: [promotedFromId], references: [id])
  promotedTo      StudentEnrollment? @relation("EnrollmentPromotion")
  
  // Historial de eventos (AUDITORÍA)
  events          EnrollmentEvent[]
  
  // Relaciones académicas
  grades              StudentGrade[]
  periodFinalGrades   PeriodFinalGrade[]
  partialGrades       PartialGrade[]
  preventiveAlerts    PreventiveAlert[]
  attendanceRecords   AttendanceRecord[]
  studentObservations StudentObservation[]
  periodRecoveries    PeriodRecovery[]
  finalRecoveryPlans  FinalRecoveryPlan[]
  academicActs        AcademicAct[]
  performanceManualEdits PerformanceManualEdit[]

  @@unique([studentId, academicYearId])
}

// ═══════════════════════════════════════════════════════════════════════════
// HISTORIAL DE MATRÍCULA (AUDITORÍA LEGAL)
// ═══════════════════════════════════════════════════════════════════════════

model EnrollmentEvent {
  id              String                  @id @default(cuid())
  enrollmentId    String
  type            EnrollmentEventType
  movementType    EnrollmentMovementType?
  
  // Auditoría de cambios
  previousValue   Json?                   // Estado anterior (para auditoría)
  newValue        Json?                   // Estado nuevo
  reason          String?                 // Motivo del cambio
  observations    String?                 // Observaciones adicionales
  
  // Referencia a acta (si aplica)
  academicActId   String?                 // Acta que respalda el cambio
  
  // Quién y cuándo
  performedById   String
  performedAt     DateTime                @default(now())
  
  enrollment      StudentEnrollment       @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  performedBy     User                    @relation("EnrollmentEventPerformedBy", fields: [performedById], references: [id])
  academicAct     AcademicAct?            @relation(fields: [academicActId], references: [id])
  
  @@index([enrollmentId])
  @@index([performedAt])
  @@index([type])
}

model StudentGrade {
  id                  String   @id @default(cuid())
  studentEnrollmentId String
  evaluativeActivityId String
  score               Decimal  @db.Decimal(3, 1)
  observations        String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  studentEnrollment StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  evaluativeActivity EvaluativeActivity @relation(fields: [evaluativeActivityId], references: [id], onDelete: Cascade)

  @@unique([studentEnrollmentId, evaluativeActivityId])
}

model PeriodFinalGrade {
  id                  String   @id @default(cuid())
  studentEnrollmentId String
  academicTermId      String
  subjectId           String
  finalScore          Decimal  @db.Decimal(3, 1)
  observations        String?
  enteredById         String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  studentEnrollment StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  academicTerm      AcademicTerm      @relation(fields: [academicTermId], references: [id], onDelete: Cascade)
  subject           Subject           @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  enteredBy         User              @relation("PeriodGradeEnteredBy", fields: [enteredById], references: [id])

  @@unique([studentEnrollmentId, academicTermId, subjectId])
}

model PartialGrade {
  id                  String   @id @default(cuid())
  studentEnrollmentId String
  teacherAssignmentId String
  academicTermId      String
  componentType       String   // COGNITIVO, PROCEDIMENTAL, ACTITUDINAL
  activityIndex       Int      // Índice de la actividad (1, 2, 3, etc.)
  activityName        String   // Nombre de la actividad
  activityType        String?  // Tipo de actividad (Examen, Taller, etc.)
  score               Decimal  @db.Decimal(3, 1)
  observations        String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  studentEnrollment StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  teacherAssignment TeacherAssignment @relation(fields: [teacherAssignmentId], references: [id], onDelete: Cascade)
  academicTerm      AcademicTerm      @relation(fields: [academicTermId], references: [id], onDelete: Cascade)

  @@unique([studentEnrollmentId, teacherAssignmentId, academicTermId, componentType, activityIndex])
  @@index([teacherAssignmentId, academicTermId])
}

 enum PreventiveAlertStatus {
   OPEN
   IN_RECOVERY
   RESOLVED
 }

 model PreventiveCutConfig {
   id           String   @id @default(cuid())
   academicTermId String
   cutoffDate   DateTime
   riskThresholdScore Decimal @db.Decimal(3, 1)
   createdAt    DateTime @default(now())
   updatedAt    DateTime @updatedAt

   academicTerm AcademicTerm @relation(fields: [academicTermId], references: [id], onDelete: Cascade)

   @@unique([academicTermId])
 }

 model PreventiveAlert {
   id                  String   @id @default(cuid())
   teacherAssignmentId String
   studentEnrollmentId String
   academicTermId      String
   cutoffDate          DateTime
   computedGrade       Decimal? @db.Decimal(3, 1)
   performanceLevel    PerformanceLevel?
   status              PreventiveAlertStatus @default(OPEN)
   recoveryPlan        String?
   meetingAt           DateTime?
   notes               String?
   createdAt           DateTime @default(now())
   updatedAt           DateTime @updatedAt

   teacherAssignment  TeacherAssignment  @relation(fields: [teacherAssignmentId], references: [id], onDelete: Cascade)
   studentEnrollment  StudentEnrollment  @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
   academicTerm       AcademicTerm       @relation(fields: [academicTermId], references: [id], onDelete: Cascade)

   @@unique([teacherAssignmentId, studentEnrollmentId, academicTermId])
   @@index([teacherAssignmentId])
   @@index([studentEnrollmentId])
   @@index([academicTermId])
 }

// ==================== ATTENDANCE ====================

enum AttendanceStatus {
  PRESENT       // Presente
  ABSENT        // Ausente
  LATE          // Tardanza
  EXCUSED       // Excusa justificada
}

model AttendanceRecord {
  id                  String   @id @default(cuid())
  teacherAssignmentId String
  studentEnrollmentId String
  date                DateTime @db.Date
  status              AttendanceStatus
  observations        String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  teacherAssignment TeacherAssignment @relation(fields: [teacherAssignmentId], references: [id], onDelete: Cascade)
  studentEnrollment StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)

  @@unique([teacherAssignmentId, studentEnrollmentId, date])
  @@index([teacherAssignmentId])
  @@index([studentEnrollmentId])
  @@index([date])
}

// ==================== STUDENT OBSERVER ====================

enum ObservationType {
  POSITIVE      // Logro, reconocimiento
  NEGATIVE      // Falta, llamado de atención
  NEUTRAL       // Observación informativa
  COMMITMENT    // Compromiso firmado
}

enum ObservationCategory {
  ACADEMIC      // Académico
  BEHAVIORAL    // Comportamental
  ATTENDANCE    // Asistencia
  UNIFORM       // Uniforme/presentación
  OTHER         // Otro
}

model StudentObservation {
  id                  String   @id @default(cuid())
  studentEnrollmentId String
  authorId            String
  date                DateTime @db.Date
  type                ObservationType
  category            ObservationCategory
  description         String
  actionTaken         String?
  parentNotified      Boolean  @default(false)
  parentNotifiedAt    DateTime?
  requiresFollowUp    Boolean  @default(false)
  followUpDate        DateTime?
  followUpNotes       String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  studentEnrollment StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  author            User              @relation(fields: [authorId], references: [id], onDelete: Restrict)

  @@index([studentEnrollmentId])
  @@index([authorId])
  @@index([date])
  @@index([type])
}

// ==================== COMMUNICATIONS ====================

enum MessageType {
  ANNOUNCEMENT    // Anuncio general
  CIRCULAR        // Circular institucional
  NOTIFICATION    // Notificación individual
  REMINDER        // Recordatorio
}

enum MessageStatus {
  DRAFT
  SENT
  SCHEDULED
}

model Message {
  id            String        @id @default(cuid())
  institutionId String
  authorId      String
  type          MessageType
  subject       String
  content       String
  status        MessageStatus @default(DRAFT)
  scheduledAt   DateTime?
  sentAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  institution Institution    @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  author      User           @relation(fields: [authorId], references: [id], onDelete: Restrict)
  recipients  MessageRecipient[]

  @@index([institutionId])
  @@index([authorId])
  @@index([status])
}

enum RecipientType {
  USER
  GROUP
  GRADE
  ALL_STUDENTS
  ALL_TEACHERS
  ALL_PARENTS
}

model MessageRecipient {
  id            String        @id @default(cuid())
  messageId     String
  recipientType RecipientType
  recipientId   String?
  readAt        DateTime?
  createdAt     DateTime      @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([recipientId])
}

// ============================================
// DASHBOARD - Noticias, Galería, Eventos
// ============================================

model Announcement {
  id            String    @id @default(cuid())
  institutionId String
  title         String
  content       String
  imageUrl      String?
  priority      Int       @default(0)
  isActive      Boolean   @default(true)
  publishedAt   DateTime  @default(now())
  expiresAt     DateTime?
  authorId      String
  
  // Visibilidad por rol - JSON array de roles que pueden ver (vacío = todos)
  // Ejemplo: ["DOCENTE", "COORDINADOR"] o ["ESTUDIANTE"]
  visibleToRoles String[]  @default([])
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  author      User        @relation("AnnouncementAuthor", fields: [authorId], references: [id])

  @@index([institutionId])
  @@index([isActive])
  @@index([publishedAt])
}

model GalleryImage {
  id            String   @id @default(cuid())
  institutionId String
  title         String
  description   String?
  imageUrl      String
  category      String?
  isActive      Boolean  @default(true)
  order         Int      @default(0)
  uploadedById  String
  
  // Visibilidad por rol - array de roles que pueden ver (vacío = todos)
  visibleToRoles String[]  @default([])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  uploadedBy  User        @relation("GalleryUploader", fields: [uploadedById], references: [id])

  @@index([institutionId])
  @@index([isActive])
  @@index([category])
}

model Event {
  id            String    @id @default(cuid())
  institutionId String
  title         String
  description   String?
  eventDate     DateTime
  endDate       DateTime?
  location      String?
  eventType     String    @default("GENERAL")
  isActive      Boolean   @default(true)
  authorId      String
  
  // Visibilidad por rol - array de roles que pueden ver (vacío = todos)
  visibleToRoles String[]  @default([])
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  author      User        @relation("EventAuthor", fields: [authorId], references: [id])

  @@index([institutionId])
  @@index([eventDate])
  @@index([isActive])
}

// ============================================
// MÓDULO DE RECUPERACIONES ACADÉMICAS
// Decreto 1290 - SIEE Colombia
// ============================================

enum RecoveryType {
  PERIOD      // Recuperación por período
  FINAL       // Recuperación final (plan de apoyo)
}

enum RecoveryStatus {
  PENDING           // Pendiente de iniciar
  IN_PROGRESS       // En proceso
  COMPLETED         // Completada
  APPROVED          // Aprobada
  NOT_APPROVED      // No aprobada
  CANCELLED         // Cancelada
}

enum RecoveryImpactType {
  ADJUST_TO_MINIMUM     // Ajustar hasta la nota mínima aprobatoria
  AVERAGE_WITH_ORIGINAL // Promediar con nota original
  REPLACE_IF_HIGHER     // Reemplazar solo si es mayor
  QUALITATIVE_ONLY      // Solo registro cualitativo (no afecta nota)
}

// AcademicActType movido a la sección de enums de Año Lectivo (línea ~102)

// Configuración institucional de recuperaciones
model RecoveryConfig {
  id                    String   @id @default(cuid())
  institutionId         String
  academicYearId        String
  
  // Configuración general
  minPassingScore       Decimal  @db.Decimal(3, 1) @default(3.0)
  
  // Recuperación por período
  periodRecoveryEnabled Boolean  @default(true)
  periodMaxScore        Decimal  @db.Decimal(3, 1) @default(3.0)
  periodImpactType      RecoveryImpactType @default(ADJUST_TO_MINIMUM)
  
  // Recuperación final
  finalRecoveryEnabled  Boolean  @default(true)
  finalMaxScore         Decimal  @db.Decimal(3, 1) @default(3.0)
  finalImpactType       RecoveryImpactType @default(ADJUST_TO_MINIMUM)
  maxAreasRecoverable   Int      @default(2)
  
  // Fechas de ventanas de recuperación
  periodRecoveryStartDate DateTime?
  periodRecoveryEndDate   DateTime?
  finalRecoveryStartDate  DateTime?
  finalRecoveryEndDate    DateTime?
  
  // Actas requeridas
  requiresAcademicCouncilAct Boolean @default(true)
  requiresPromotionAct       Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  institution  Institution  @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@unique([institutionId, academicYearId])
}

// Recuperación por período
model PeriodRecovery {
  id                    String   @id @default(cuid())
  studentEnrollmentId   String
  academicTermId        String
  subjectId             String
  
  // Nota original que generó la recuperación
  originalScore         Decimal  @db.Decimal(3, 1)
  
  // Información de la recuperación
  status                RecoveryStatus @default(PENDING)
  activityDescription   String?  @db.Text
  scheduledDate         DateTime?
  completedDate         DateTime?
  
  // Dimensión reforzada
  reinforcedDimension   String?  @default("COGNITIVA")
  
  // Resultado
  recoveryScore         Decimal? @db.Decimal(3, 1)
  finalScore            Decimal? @db.Decimal(3, 1)
  impactType            RecoveryImpactType?
  
  // Evidencias y observaciones
  evidences             String?  @db.Text
  observations          String?  @db.Text
  
  // Responsables
  assignedById          String
  evaluatedById         String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentEnrollment StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  academicTerm      AcademicTerm      @relation("PeriodRecoveryTerm", fields: [academicTermId], references: [id], onDelete: Cascade)
  subject           Subject           @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  assignedBy        User              @relation("RecoveryAssignedBy", fields: [assignedById], references: [id])
  evaluatedBy       User?             @relation("RecoveryEvaluatedBy", fields: [evaluatedById], references: [id])

  @@index([studentEnrollmentId])
  @@index([academicTermId])
  @@index([status])
}

// Plan de apoyo final (recuperación final por área)
model FinalRecoveryPlan {
  id                    String   @id @default(cuid())
  studentEnrollmentId   String
  academicYearId        String
  areaId                String
  
  // Nota final del área que generó el plan
  originalAreaScore     Decimal  @db.Decimal(3, 1)
  
  // Estado del plan
  status                RecoveryStatus @default(PENDING)
  
  // Plan de actividades
  activities            String?  @db.Text
  objectives            String?  @db.Text
  resources             String?  @db.Text
  
  // Fechas
  startDate             DateTime?
  endDate               DateTime?
  completedDate         DateTime?
  
  // Resultado
  recoveryScore         Decimal? @db.Decimal(3, 1)
  finalAreaScore        Decimal? @db.Decimal(3, 1)
  impactType            RecoveryImpactType?
  
  // Evidencias y observaciones
  evidences             String?  @db.Text
  observations          String?  @db.Text
  
  // Responsables
  responsibleTeacherId  String
  supervisorId          String?
  
  // Decisión final
  finalDecision         String?
  approvedById          String?
  approvalDate          DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentEnrollment  StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  academicYear       AcademicYear      @relation("FinalRecoveryYear", fields: [academicYearId], references: [id], onDelete: Cascade)
  area               Area              @relation(fields: [areaId], references: [id], onDelete: Cascade)
  responsibleTeacher User              @relation("FinalRecoveryTeacher", fields: [responsibleTeacherId], references: [id])
  supervisor         User?             @relation("FinalRecoverySupervisor", fields: [supervisorId], references: [id])
  approvedBy         User?             @relation("FinalRecoveryApprover", fields: [approvedById], references: [id])
  academicActs       AcademicAct[]

  @@index([studentEnrollmentId])
  @@index([academicYearId])
  @@index([status])
}

// Actas académicas
model AcademicAct {
  id                    String   @id @default(cuid())
  institutionId         String
  academicYearId        String
  
  // Tipo y número de acta
  actType               AcademicActType
  actNumber             String
  actDate               DateTime
  
  // Contenido
  title                 String
  content               String   @db.Text
  decisions             String?  @db.Text
  attendees             String?  @db.Text
  
  // Relaciones opcionales
  studentEnrollmentId   String?
  finalRecoveryPlanId   String?
  
  // Firmas y aprobación
  createdById           String
  approvedById          String?
  approvalDate          DateTime?
  
  // Documento generado
  documentUrl           String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  institution       Institution        @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  academicYear      AcademicYear       @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  studentEnrollment StudentEnrollment? @relation(fields: [studentEnrollmentId], references: [id])
  finalRecoveryPlan FinalRecoveryPlan? @relation(fields: [finalRecoveryPlanId], references: [id])
  createdBy         User               @relation("ActCreatedBy", fields: [createdById], references: [id])
  approvedBy        User?              @relation("ActApprovedBy", fields: [approvedById], references: [id])
  
  // Eventos de matrícula relacionados con esta acta
  enrollmentEvents  EnrollmentEvent[]

  @@index([institutionId])
  @@index([academicYearId])
  @@index([actType])
}

// ==================== SISTEMA DE DESEMPEÑOS ====================

// Dimensiones de evaluación (Cognitivo, Procedimental, Actitudinal)
enum PerformanceDimension {
  COGNITIVO
  PROCEDIMENTAL
  ACTITUDINAL
}

// Configuración de complementos por nivel de desempeño
model PerformanceLevelComplement {
  id            String           @id @default(cuid())
  institutionId String
  level         PerformanceLevel
  complement    String           @db.Text
  isActive      Boolean          @default(true)
  displayMode   ComplementDisplayMode @default(CONCATENATE)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@unique([institutionId, level])
}

enum ComplementDisplayMode {
  CONCATENATE      // Se concatena al texto base
  SEPARATE_LINE    // Se muestra en línea separada
}

// Configuración del módulo de desempeños por institución
model PerformanceConfig {
  id                      String   @id @default(cuid())
  institutionId           String   @unique
  isEnabled               Boolean  @default(true)
  showByDimension         Boolean  @default(true)   // true = por dimensión, false = consolidado
  allowManualEdit         Boolean  @default(false)  // Permitir edición manual excepcional
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
}

// Desempeño base registrado por el docente (por asignatura, período y dimensión)
model SubjectPerformance {
  id                    String               @id @default(cuid())
  teacherAssignmentId   String
  academicTermId        String
  dimension             PerformanceDimension
  baseDescription       String               @db.Text
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  teacherAssignment TeacherAssignment @relation(fields: [teacherAssignmentId], references: [id], onDelete: Cascade)
  academicTerm      AcademicTerm      @relation(fields: [academicTermId], references: [id], onDelete: Cascade)

  @@unique([teacherAssignmentId, academicTermId, dimension])
  @@index([teacherAssignmentId])
  @@index([academicTermId])
}

// Registro de ediciones manuales (auditoría)
model PerformanceManualEdit {
  id                    String               @id @default(cuid())
  studentEnrollmentId   String
  academicTermId        String
  subjectId             String
  dimension             PerformanceDimension
  originalText          String               @db.Text
  editedText            String               @db.Text
  reason                String
  editedById            String
  createdAt             DateTime             @default(now())

  studentEnrollment StudentEnrollment @relation(fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  academicTerm      AcademicTerm      @relation(fields: [academicTermId], references: [id], onDelete: Cascade)
  subject           Subject           @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  editedBy          User              @relation("PerformanceEditedBy", fields: [editedById], references: [id])

  @@index([studentEnrollmentId])
  @@index([academicTermId])
}

// ═══════════════════════════════════════════════════════════════════════════
// SISTEMA DE PERMISOS GRANULARES
// ═══════════════════════════════════════════════════════════════════════════

// Catálogo maestro de permisos (definido por el sistema)
model Permission {
  id          String   @id @default(cuid())
  code        String   @unique  // Ej: "CONFIG_GRADING_EDIT_SCALE"
  module      String   // Ej: "CONFIG_INSTITUTIONAL"
  function    String   // Ej: "GRADING_SYSTEM"
  subFunction String   // Ej: "EDIT_SCALE"
  name        String   // Ej: "Cambiar escala de notas"
  description String?
  createdAt   DateTime @default(now())
  
  rolePermissions RoleBasePermission[]
  userPermissions UserExtraPermission[]
  auditLogs       PermissionAuditLog[]
}

// Permisos base por rol (FIJOS - definidos por el sistema, no editables por Admin)
model RoleBasePermission {
  id           String     @id @default(cuid())
  role         String     // "ADMIN_INSTITUTIONAL", "RECTOR", "COORDINADOR", "DOCENTE"
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  
  @@unique([role, permissionId])
  @@index([role])
}

// Permisos extra por usuario (temporales o permanentes)
model UserExtraPermission {
  id           String      @id @default(cuid())
  userId       String
  user         User        @relation("UserExtraPermissions", fields: [userId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission  @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  // Quién otorgó el permiso
  grantedById  String
  grantedBy    User        @relation("GrantedPermissions", fields: [grantedById], references: [id])
  grantedAt    DateTime    @default(now())
  
  // Vigencia (null = permanente)
  validFrom    DateTime    @default(now())
  validTo      DateTime?   // null = sin expiración
  
  // Metadata
  reason       String      // Obligatorio para auditoría
  isActive     Boolean     @default(true)
  revokedAt    DateTime?
  revokedById  String?
  revokedBy    User?       @relation("RevokedPermissions", fields: [revokedById], references: [id])
  revokeReason String?
  
  @@unique([userId, permissionId])
  @@index([userId])
  @@index([validTo])
}

// Tipos de acciones de auditoría
enum PermissionAuditAction {
  GRANT           // Otorgar permiso extra
  REVOKE          // Revocar permiso extra
  EXPIRE          // Expiración automática
  ROLE_ASSIGN     // Asignar rol a usuario
  ROLE_REMOVE     // Quitar rol a usuario
  RULE_CHANGE     // Cambio de reglas académicas
  PERIOD_OPEN     // Apertura de período
  PERIOD_CLOSE    // Cierre de período
  WINDOW_OPEN     // Apertura de ventana
  WINDOW_CLOSE    // Cierre de ventana
}

// Auditoría de permisos (OBLIGATORIA)
model PermissionAuditLog {
  id            String                @id @default(cuid())
  institutionId String
  institution   Institution           @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  
  // Acción realizada
  action        PermissionAuditAction
  
  // Usuario afectado
  targetUserId  String
  targetUser    User                  @relation("AuditTarget", fields: [targetUserId], references: [id])
  
  // Permiso afectado (opcional, para cambios de rol es null)
  permissionId  String?
  permission    Permission?           @relation(fields: [permissionId], references: [id])
  
  // Para cambios de rol
  oldRole       String?
  newRole       String?
  
  // Quién realizó la acción
  performedById String
  performedBy   User                  @relation("AuditPerformer", fields: [performedById], references: [id])
  performedAt   DateTime              @default(now())
  
  // Detalles
  reason        String?
  metadata      Json?                 // Datos adicionales (fechas, configuraciones, etc.)
  ipAddress     String?
  
  @@index([institutionId, performedAt])
  @@index([targetUserId])
  @@index([action])
}
